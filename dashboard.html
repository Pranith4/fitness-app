<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  
<div class="card prize">
<h3>ğŸ† Prize Pool</h3>
<h1>â‚¹6,000</h1>
<p>Top % fat loss wins!</p>
</div>

<div class="video-bg">
<iframe src="https://www.youtube.com/embed/eAlNvWgTDZQ?autoplay=1&mute=1&loop=1&playlist=eAlNvWgTDZQ&controls=0"></iframe>
</div>

<div class="header">
<h2 id="welcome"></h2>
<button onclick="refreshAll()">ğŸ”„ Refresh</button>
</div>

<div class="layout">

<div class="leftPanel">

<div class="card smallChart">
<h3>ğŸ† Group Progress</h3>
<canvas id="groupChart"></canvas>
</div>
  
<div class="card">
  <h3>ğŸ“ˆ Your Trend</h3>
  <canvas id="userChart"></canvas>
  <p id="streakDisplay" style="margin-top:10px;color:#ff2e63;font-weight:bold"></p>
</div>

<div class="card">
<h3>ğŸ“Š Weight Matrix</h3>
<table id="matrixTable"></table>
</div>

<div class="card">
<h3>ğŸ“ˆ Your Trend</h3>
<canvas id="userChart"></canvas>
</div>

<div class="card">
<h3>â• Add Today's Weight</h3>
<input id="weight" placeholder="Enter weight">
<button onclick="addWeight()">Submit</button>
<p id="msg"></p>
</div>

</div>

<div class="rightPanel">
<div class="card">
<h3>ğŸ¯ Goal Planner</h3>
<input id="startWeight" placeholder="Start Weight">
<input id="targetWeight" placeholder="Target Weight">
<input type="date" id="startDate">
<input type="date" id="endDate">
<button onclick="saveGoal()">Save Goal</button>

<div class="goalStats">
<p>Total Loss: <b id="totalLoss"></b></p>
<p>Total Days: <b id="totalDays"></b></p>
<p>Daily Required: <b id="dailyLoss"></b></p>
<p>Expected Today: <b id="expectedToday"></b></p>
<p>Status: <b id="goalStatus"></b></p>
</div>
</div>
</div>

</div>

<script>
  const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
welcome.innerText="Welcome, "+user;

let groupChart,userChart;

/* ----------- DATE PARSER ----------- */
function parseDate(str){
const p=str.split("-");
return new Date(p[0],p[1]-1,p[2]);
}

/* ----------- GROUP + MATRIX ----------- */
async function loadGroupData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
if(data.length<=1) return;

const rows=data.slice(1);
let users={},datesSet=new Set();

rows.forEach(r=>{
let d=new Date(r[1]).toISOString().split('T')[0];
datesSet.add(d);
if(!users[r[0]]) users[r[0]]=[];
users[r[0]].push({date:d,weight:parseFloat(r[2])});
});

const dates=[...datesSet].sort();

/* GROUP CHART */
let datasets=Object.keys(users).map(name=>({
label:name,
data:dates.map(d=>users[name].find(x=>x.date===d)?.weight||null),
tension:0.4
}));

if(groupChart) groupChart.destroy();
groupChart=new Chart(document.getElementById("groupChart"),{
type:"line",
data:{labels:dates,datasets}
});

/* MATRIX TABLE */
let html="<tr><th>Name</th>"+dates.map(d=>`<th>${d}</th>`).join("")+"<th>% Change</th></tr>";

Object.keys(users).forEach(name=>{
let rec=users[name].sort((a,b)=>new Date(a.date)-new Date(b.date));
let initial=rec[0].weight;
let latest=rec[rec.length-1].weight;
let percent=((initial-latest)/initial*100).toFixed(2);

html+="<tr><td>"+name+"</td>";
dates.forEach(d=>{
let r=rec.find(x=>x.date===d);
html+="<td>"+(r?r.weight:"-")+"</td>";
});
html+=`<td style="color:${percent>0?'#00ff88':'#ff4d4d'}">${percent}%</td></tr>`;
});

matrixTable.innerHTML=html;
}

/* ----------- USER DATA + STREAK ----------- */
async function loadUserData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const rows=await res.json();
if(rows.length===0) return;

const dates=rows.map(r=>new Date(r[1]).toLocaleDateString());
const weights=rows.map(r=>parseFloat(r[2]));

if(userChart) userChart.destroy();
userChart=new Chart(document.getElementById("userChart"),{
type:"line",
data:{labels:dates,datasets:[{label:"Your Weight",data:weights,tension:0.4}]}
});

/* STREAK */
let streak=1;
for(let i=rows.length-1;i>0;i--){
let d1=new Date(rows[i][1]);
let d2=new Date(rows[i-1][1]);
let diff=(d1-d2)/(1000*60*60*24);
if(diff<=1) streak++;
else break;
}
streakDisplay.innerText="ğŸ”¥ Current Streak: "+streak+" Days";
}

/* ----------- GOAL ----------- */
async function loadGoal(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getGoal",username:user})});
const g=await res.json();
if(!g.startWeight||!g.endDate) return;

const end=parseDate(g.endDate);
const today=new Date();
const daysRemaining=Math.ceil((end-today)/(1000*60*60*24));

const res2=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const rows=await res2.json();
if(rows.length===0) return;

const current=parseFloat(rows[rows.length-1][2]);
const target=parseFloat(g.targetWeight);
const avgDaily=((current-target)/daysRemaining).toFixed(2);

totalLoss.innerText=daysRemaining+" days left";
totalDays.innerText=avgDaily+" kg/day needed";
}

/* ----------- ADD ----------- */
async function addWeight(){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
weight.value="";
refreshAll();
}

function refreshAll(){ loadGroupData(); loadUserData(); loadGoal(); }
refreshAll();
setInterval(refreshAll,30000);


</script>
</body>
</html>
