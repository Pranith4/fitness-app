<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Challenge Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ TOTAL PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <p>Standings updated in real-time</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <span>Days Remaining</span>
                <h2 id="daysLeftVal">--</h2>
            </div>
            <div class="stat-box">
                <span>Daily Target</span>
                <h2 id="targetVal">--</h2>
            </div>
            <div class="stat-box">
                <span>Your Total Loss</span>
                <h2 id="personalLossVal">--</h2>
            </div>
        </div>

        <div class="card">
            <h3>üìà Group Progress Trend</h3>
            <canvas id="groupChart" height="120"></canvas>
        </div>

        <div class="card">
            <h3>ü•á Leaderboard (% Weight Lost)</h3>
            <div style="overflow-x: auto;">
                <table id="matrixTable"></table>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card profile-card">
            <h2 id="welcomeText">Athlete</h2>
            <button onclick="refreshAll()" class="btn-refresh">üîÑ Sync Data</button>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Daily Weight</h3>
            <div class="input-group">
                <input type="number" step="0.1" id="weightInput" placeholder="Enter kg (e.g. 75.4)">
                <button onclick="addWeight()" class="btn-primary">Submit Entry</button>
            </div>
            <p id="msg" style="font-size:0.8rem; margin-top:8px; text-align:center;"></p>
        </div>

        <div class="card goal-card">
            <h3>üéØ Goal Settings</h3>
            <div class="goal-form">
                <label>Starting Weight (kg)</label>
                <input type="number" id="startW">
                
                <label>Target Weight (kg)</label>
                <input type="number" id="targetW">
                
                <label>Target End Date</label>
                <input type="date" id="endD">
                
                <button onclick="saveGoal()" class="btn-secondary">Update Goal</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; // Update this
const user = localStorage.getItem("user");
document.getElementById("welcomeText").innerText = user || "User";

let groupChart;

async function saveGoal() {
    const data = {
        action: "saveGoal",
        username: user,
        startWeight: document.getElementById("startW").value,
        targetWeight: document.getElementById("targetW").value,
        startDate: new Date().toISOString().split('T')[0], // Sets current date as StartDate
        endDate: document.getElementById("endD").value
    };
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify(data)});
    const result = await res.json();
    if(result.success) { 
        alert("Challenge Goal Updated!"); 
        refreshAll(); 
    }
}

async function loadGoal() {
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"getGoal", username:user})});
    const g = await res.json();
    if(!g.targetWeight) return;

    document.getElementById("startW").value = g.startWeight;
    document.getElementById("targetW").value = g.targetWeight;
    document.getElementById("endD").value = g.endDate ? g.endDate.split('T')[0] : "";

    const today = new Date();
    const end = new Date(g.endDate);
    const daysLeft = Math.ceil((end - today) / (1000*60*60*24));
    document.getElementById("daysLeftVal").innerText = Math.max(0, daysLeft) + " Days";
}

async function addWeight() {
    const w = document.getElementById("weightInput").value;
    if(!w) return;
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"addWeight", username:user, weight:w})});
    const result = await res.json();
    const msgEl = document.getElementById("msg");
    msgEl.innerText = result.success ? "‚úÖ Logged successfully!" : "‚ùå " + result.message;
    msgEl.style.color = result.success ? "#00ff88" : "#ff4d4d";
    if(result.success) refreshAll();
}

async function loadGroupData() {
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"getAllWeights"})});
    const data = await res.json();
    if (data.length <= 1) return;
    
    const rows = data.slice(1);
    let usersMap = {}, datesSet = new Set();

    rows.forEach(r => {
        let d = new Date(r[1]).toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        datesSet.add(d);
        if(!usersMap[r[0]]) usersMap[r[0]] = [];
        usersMap[r[0]].push({date: d, weight: parseFloat(r[2])});
    });

    const dates = [...datesSet];
    const colors = ['#4facfe', '#ff2e63', '#00ff88', '#f8ff00', '#ae7aff'];
    
    let datasets = Object.keys(usersMap).map((name, i) => ({
        label: name,
        data: dates.map(d => usersMap[name].find(x => x.date === d)?.weight || null),
        borderColor: colors[i % colors.length],
        tension: 0.3,
        borderWidth: 3,
        pointBackgroundColor: colors[i % colors.length]
    }));

    if(groupChart) groupChart.destroy();
    groupChart = new Chart(document.getElementById("groupChart"), {
        type: 'line',
        data: { labels: dates, datasets },
        options: { 
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } },
            scales: { 
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                x: { ticks: { color: '#94a3b8' } }
            }
        }
    });

    updateLeaderboard(usersMap);
}

function updateLeaderboard(usersMap) {
    let tableHtml = `<tr><th>Rank</th><th>Athlete</th><th>Current</th><th>Total Loss</th><th>% Lost</th></tr>`;
    
    let leaderboard = Object.keys(usersMap).map(u => {
        const uWeights = usersMap[u].map(x => x.weight);
        const start = uWeights[0];
        const latest = uWeights[uWeights.length-1];
        const loss = (start - latest).toFixed(1);
        const pct = ((loss / start) * 100).toFixed(2);
        return { name: u, latest, loss, pct };
    });

    leaderboard.sort((a, b) => b.pct - a.pct);

    leaderboard.forEach((item, idx) => {
        if(item.name === user) {
            document.getElementById("personalLossVal").innerText = item.loss + " kg";
        }
        tableHtml += `<tr>
            <td>${idx + 1}</td>
            <td style="font-weight:bold">${item.name}</td>
            <td>${item.latest}kg</td>
            <td>${item.loss}kg</td>
            <td style="color:#00ff88; font-weight:bold">${item.pct}%</td>
        </tr>`;
    });
    document.getElementById("matrixTable").innerHTML = tableHtml;
}

function refreshAll() { loadGroupData(); loadGoal(); }
refreshAll();
</script>
</body>
</html>
