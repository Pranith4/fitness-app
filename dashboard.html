<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Dashboard</title>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --primary: #00d2ff;
            --gold: #fbbf24; --text: #f8fafc; --text-muted: #94a3b8;
            --danger: #ff4d4d; --success: #00ff88;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; }
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Goal Card Styling */
        .goal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .goal-box { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; text-align: center; }
        .goal-box span { font-size: 0.65rem; color: var(--text-muted); display: block; margin-bottom: 5px; text-transform: uppercase; }
        .goal-box h4 { font-size: 1.1rem; color: #fff; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; margin-top: 5px; }
        .on-track { background: rgba(0, 255, 136, 0.2); color: var(--success); }
        .off-track { background: rgba(255, 77, 77, 0.2); color: var(--danger); }

        .prize-hero { text-align: center; border: 2px solid var(--primary); background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .prize-hero h1 { font-size: 2.5rem; color: var(--primary); margin: 5px 0; }
        
        /* Chat UI */
        #chat-window { position: fixed; bottom: 85px; right: 20px; width: 340px; height: 450px; background: var(--card-bg); border: 1px solid var(--primary); border-radius: 20px; display: flex; flex-direction: column; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .chat-hidden { display: none; }
        .chat-header { background: var(--primary); color: #000; padding: 12px 15px; font-weight: bold; border-radius: 19px 19px 0 0; display: flex; justify-content: space-between; }
        #chat-body { flex-grow: 1; padding: 15px; overflow-y: auto; font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px; }
        .bot-msg { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 12px 12px 12px 0; align-self: flex-start; max-width: 80%; }
        .user-msg { background: var(--primary); color: #000; padding: 8px 12px; border-radius: 12px 12px 0 12px; align-self: flex-end; max-width: 80%; }
        .chat-input { display: flex; padding: 12px; gap: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        input { background: #0f172a; color: #fff; border: 1px solid #334155; padding: 10px; border-radius: 8px; flex-grow: 1; outline: none; }
        button { background: var(--primary); border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #chat-trigger { position: fixed; bottom: 20px; right: 20px; background: var(--primary); width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(0,210,255,0.4); }

        @media (max-width: 850px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-content">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
        </div>

        <div class="card">
            <h3 style="color:var(--gold)">üéØ Personal Goal Progress</h3>
            <div class="goal-grid">
                <div class="goal-box">
                    <span>Days Remaining</span>
                    <h4 id="stat-days">--</h4>
                </div>
                <div class="goal-box">
                    <span>Next Mon Target</span>
                    <h4 id="stat-next-week">--</h4>
                </div>
                <div class="goal-box">
                    <span>Goal Status</span>
                    <div id="stat-status" class="status-badge">Syncing...</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Matrix Standings</h3>
            <div id="table-container" style="font-size: 0.8rem; overflow-x: auto;">Fetching leaderboard...</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h2 id="userName">Athlete</h2>
            <p style="color:var(--text-muted); font-size: 0.8rem;">Ready to crush your goals?</p>
        </div>
        <div class="card">
            <h3>‚öñÔ∏è Log Monday Weight</h3>
            <input type="number" step="0.1" id="weightInput" placeholder="Enter kg">
            <button onclick="submitWeight()" style="width:100%; margin-top:10px">Update Sheets</button>
        </div>
    </div>
</div>

<div id="chat-trigger" onclick="toggleChat()">ü§ñ</div>
<div id="chat-window" class="chat-hidden">
    <div class="chat-header"><span>Coach AI</span><span onclick="toggleChat()" style="cursor:pointer">&times;</span></div>
    <div id="chat-body"><div class="bot-msg">Welcome! I can help you with diet and workout tips. How's the journey?</div></div>
    <div class="chat-input">
        <input type="text" id="userQuery" placeholder="Ask a question...">
        <button onclick="coachResponse()">üöÄ</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
    const HF_TOKEN = "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";
    const CURRENT_USER = localStorage.getItem("username") || "Guest"; 
    document.getElementById("userName").innerText = CURRENT_USER;

    async function initDashboard() {
        try {
            // Fetching all data (Ensure your Apps Script returns an object with 'users' and 'entries')
            const response = await fetch(API_URL);
            const data = await response.json();
            
            // Find current user's goal data from "USERS" sheet
            const userData = data.users.find(u => u.name === CURRENT_USER);
            // Get latest weight from "ENTRIES" sheet
            const userEntries = data.entries.filter(e => e.name === CURRENT_USER);
            const currentWeight = userEntries.length > 0 ? userEntries[userEntries.length-1].weight : userData.startWeight;

            if (userData) {
                calculateGoalStats(
                    parseFloat(currentWeight), 
                    parseFloat(userData.targetWeight), 
                    userData.endDate, 
                    userData.startWeight, 
                    userData.startDate
                );
            }
            // renderTable(data.entries); // Assuming you have a table renderer
        } catch (e) {
            console.error("Dashboard Sync Failed", e);
        }
    }

    function calculateGoalStats(current, target, endStr, startWeight, startStr) {
        const today = new Date();
        const endDate = new Date(endStr);
        const startDate = new Date(startStr);

        // 1. Days Remaining
        const diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        document.getElementById("stat-days").innerText = diffDays > 0 ? diffDays : "Done";

        // 2. Next Monday Target
        // Logic: Calculate how much weight remains to be lost divided by weeks remaining
        const weightRemaining = current - target;
        const weeksRemaining = diffDays / 7;
        const lossPerWeekNeeded = weightRemaining / weeksRemaining;
        const nextTarget = (current - lossPerWeekNeeded).toFixed(1);
        document.getElementById("stat-next-week").innerText = weeksRemaining > 0 ? `${nextTarget} kg` : "Goal Hit";

        // 3. Status Logic (On Track vs Behind)
        // 
        const totalDuration = endDate - startDate;
        const elapsed = today - startDate;
        const progressPercent = elapsed / totalDuration;
        const idealWeightAtThisPoint = startWeight - ((startWeight - target) * progressPercent);

        const statusEl = document.getElementById("stat-status");
        if (current <= idealWeightAtThisPoint + 0.5) { // 0.5kg buffer
            statusEl.innerText = "ON TRACK";
            statusEl.className = "status-badge on-track";
        } else {
            statusEl.innerText = "BEHIND PACE";
            statusEl.className = "status-badge off-track";
        }
    }

    async function coachResponse() {
        const queryInput = document.getElementById("userQuery");
        const chatBody = document.getElementById("chat-body");
        const query = queryInput.value.trim();
        if(!query) return;

        chatBody.innerHTML += `<div class="user-msg">${query}</div>`;
        queryInput.value = "";
        chatBody.scrollTop = chatBody.scrollHeight;

        try {
            const res = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2", {
                method: "POST",
                headers: { "Authorization": `Bearer ${HF_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ inputs: `[INST] You are the Dark Shine Fitness Coach. Answer this briefly: ${query} [/INST]` })
            });
            const data = await res.json();
            const reply = data[0].generated_text.split("[/INST]").pop().trim();
            chatBody.innerHTML += `<div class="bot-msg">${reply}</div>`;
        } catch (e) {
            chatBody.innerHTML += `<div class="bot-msg" style="color:var(--danger)">Offline.</div>`;
        }
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function toggleChat() { document.getElementById("chat-window").classList.toggle("chat-hidden"); }
    
    // Start
    initDashboard();
</script>
</body>
</html>
