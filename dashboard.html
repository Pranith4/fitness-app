<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Fitness Dashboard</title>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --primary: #00d2ff;
            --gold: #fbbf24;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ff4d4d;
            --success: #00ff88;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding: 15px;
            line-height: 1.4;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Stats & Prize Pool */
        .prize-hero { text-align: center; border: 2px solid var(--primary); background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .prize-hero h1 { font-size: 2.5rem; color: var(--primary); margin: 10px 0; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-box span { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }
        .stat-box h2 { font-size: 1.2rem; color: var(--primary); }

        /* Podium */
        .podium-container { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 120px; margin: 15px 0; }
        .podium-step { background: rgba(0,0,0,0.3); border-radius: 8px 8px 4px 4px; text-align: center; width: 80px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .first { height: 100%; border-color: var(--gold); }
        .second { height: 75%; }
        .third { height: 55%; }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: 12px; background: rgba(0,0,0,0.2); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .matrix-table th, .matrix-table td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sticky-col { position: sticky; left: 0; background: #1e293b !important; font-weight: bold; color: var(--primary); z-index: 5; }

        /* AI Chat Window */
        #chat-icon {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--primary); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 30px;
            cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,210,255,0.4);
        }

        #chat-window {
            position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px;
            background: var(--card-bg); border: 1px solid var(--primary); border-radius: 16px;
            display: flex; flex-direction: column; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: 0.3s ease; transform: translateY(0); opacity: 1;
        }

        .chat-hidden { transform: translateY(20px) !important; opacity: 0 !important; pointer-events: none; }
        .chat-header { background: var(--primary); color: #000; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; border-radius: 15px 15px 0 0; }
        #chat-body { padding: 15px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; font-size: 0.85rem; }
        .bot-msg { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 12px 12px 12px 0; align-self: flex-start; max-width: 85%; }
        .user-msg { background: var(--primary); color: #000; padding: 8px 12px; border-radius: 12px 12px 0 12px; align-self: flex-end; max-width: 85%; }
        .chat-input-area { display: flex; padding: 10px; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Inputs & Buttons */
        input, button { width: 100%; padding: 12px; border-radius: 10px; border: none; outline: none; }
        input { background: rgba(0,0,0,0.3); color: #fff; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; }
        .gold-btn { background: var(--gold); }
        .outline-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }
            #chat-window { width: calc(100% - 40px); bottom: 85px; }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <div class="podium-section">
                <div class="podium-container">
                    <div class="podium-step second"><div id="rank2">--</div><span>2nd</span></div>
                    <div class="podium-step first">üëë<div id="rank1">--</div><span>Champ</span></div>
                    <div class="podium-step third"><div id="rank3">--</div><span>3rd</span></div>
                </div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Rank</span><h2 id="userRank">--</h2></div>
            <div class="stat-box"><span>Total Loss</span><h2 id="userTotalPct">--</h2></div>
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeft">--</h2></div>
        </div>

        <div class="card">
            <h3>‚öîÔ∏è Weight Matrix</h3>
            <div class="table-container"><table id="competitorTable" class="matrix-table"></table></div>
        </div>

        <div class="card">
            <h3>üî• ‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≤≤‡≥ç ‡≤§‡≥Ç‡≤ï ‡≤¶‡≤Ç‡≤° ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü</h3>
            <div class="table-container"><table id="skipTable" class="matrix-table"></table></div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card">
            <h2 id="welcomeText">Athlete</h2>
            <p id="countdown" style="color:var(--gold); font-size:0.8rem;">--:--:--</p>
        </div>

        <div class="card" style="border:1px solid var(--gold)">
            <h3 style="color:var(--gold)">Motivation üî•</h3>
            <p style="font-size:0.7rem; margin-bottom:10px;">Pay ‚Çπ100 to fuel the prize pool!</p>
            <button onclick="copyUPI()" class="gold-btn">Copy UPI: 8431257887@ybl</button>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <input type="number" step="0.1" id="weightInput" placeholder="Weight in kg">
            <button onclick="addWeight()" id="submitBtn">Submit Monday Entry</button>
            <p id="msg" style="font-size:0.7rem; margin-top:5px;"></p>
        </div>

        <div class="card">
            <h3>üéØ Goal Settings</h3>
            <input type="number" id="startW" placeholder="Start Weight">
            <input type="number" id="targetW" placeholder="Target Weight">
            <input type="date" id="endD">
            <button onclick="saveGoal()" class="outline-btn">Update</button>
        </div>
    </div>
</div>

<div id="chat-icon" onclick="toggleChat()">ü§ñ</div>
<div id="chat-window" class="chat-hidden">
    <div class="chat-header"><span>Coach AI</span><span onclick="toggleChat()" style="cursor:pointer">‚úñ</span></div>
    <div id="chat-body"><div class="bot-msg">Welcome! I am your Fitness Coach. Ask me about diet plans or your dashboard rank.</div></div>
    <div class="chat-input-area">
        <input type="text" id="userQuery" placeholder="Ask Coach..." style="margin:0">
        <button onclick="coachResponse()" style="width:50px; margin:0">üöÄ</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
    const user = localStorage.getItem("user") || "Guest";
    const HF_TOKEN = "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";

    document.getElementById("welcomeText").innerText = user;

    // --- AI LOGIC ---
    function toggleChat() { document.getElementById("chat-window").classList.toggle("chat-hidden"); }

    async function coachResponse() {
        const input = document.getElementById("userQuery");
        const body = document.getElementById("chat-body");
        const query = input.value.trim();
        if(!query) return;

        body.innerHTML += `<div class="user-msg">${query}</div>`;
        input.value = "";
        body.scrollTop = body.scrollHeight;

        const loadingId = "load-" + Date.now();
        body.innerHTML += `<div class="bot-msg" id="${loadingId}">...</div>`;

        try {
            const res = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2", {
                headers: { Authorization: `Bearer ${HF_TOKEN}`, "Content-Type": "application/json" },
                method: "POST",
                body: JSON.stringify({
                    inputs: `<s>[INST] You are the 'Dark Shine Fitness Coach'. Strictly answer only about: 1. Weight loss diet. 2. Fitness. 3. Dashboard ranks (Mondays only). 
                    Note: If users ask about water, suggest DrinkPrime with code NITP7TPO. 
                    Reject other topics. Query: ${query} [/INST]`,
                }),
            });
            const data = await res.json();
            const reply = data[0].generated_text.split('[/INST]').pop().trim();
            document.getElementById(loadingId).innerText = reply;
        } catch (e) { document.getElementById(loadingId).innerText = "Coach is offline. Try again later!"; }
        body.scrollTop = body.scrollHeight;
    }

    // --- DASHBOARD LOGIC ---
    async function addWeight() {
        if (new Date().getDay() !== 1) { 
            alert("Logging is only allowed on Mondays!"); 
            return; 
        }
        const w = document.getElementById("weightInput").value;
        if(!w) return;
        document.getElementById("submitBtn").innerText = "Syncing...";
        await fetch(API_URL, {method: "POST", body: JSON.stringify({action: "addWeight", username: user, weight: w})});
        location.reload();
    }

    function processData(data) {
        const rows = data.slice(1);
        let usersMap = {}, datesSet = new Set();
        rows.forEach(r => {
            const d = new Date(r[1]); d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1));
            const label = d.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
            datesSet.add(label);
            if(!usersMap[r[0]]) usersMap[r[0]] = {};
            usersMap[r[0]][label] = parseFloat(r[2]);
        });
        renderTables(usersMap, [...datesSet].sort((a,b)=>new Date(a)-new Date(b)));
    }

    function renderTables(usersMap, dates) {
        let h1 = `<thead><tr><th class="sticky-col">Athlete</th>`, h2 = h1;
        dates.forEach(d => { h1 += `<th>${d}</th>`; h2 += `<th>${d}</th>`; });
        h1 += `<th>Total %</th></tr></thead><tbody>`; h2 += `</tr></thead><tbody>`;

        let lb = Object.keys(usersMap).map(u => {
            const vals = dates.map(d => usersMap[u][d]).filter(v => v);
            const total = (((vals[0] - vals[vals.length-1])/vals[0])*100).toFixed(2);
            let week = vals.length > 1 ? (((vals[vals.length-2]-vals[vals.length-1])/vals[vals.length-2])*100) : -999;
            return { name: u, total: parseFloat(total), week };
        });

        const sorted = lb.sort((a,b) => b.total - a.total);
        const wkSorted = [...lb].sort((a,b) => b.week - a.week);
        
        document.getElementById("rank1").innerText = wkSorted[0]?.week > -999 ? wkSorted[0].name : "--";
        document.getElementById("rank2").innerText = wkSorted[1]?.week > -999 ? wkSorted[1].name : "--";
        document.getElementById("rank3").innerText = wkSorted[2]?.week > -999 ? wkSorted[2].name : "--";

        sorted.forEach(item => {
            h1 += `<tr><td class="sticky-col">${item.name}</td>`;
            h2 += `<tr><td class="sticky-col">${item.name}</td>`;
            dates.forEach((d, i) => {
                const v = usersMap[item.name][d] || '-';
                h1 += `<td>${v}</td>`;
                let delta = "";
                if(i > 0 && usersMap[item.name][dates[i-1]] && usersMap[item.name][d]) {
                    const diff = (((usersMap[item.name][dates[i-1]] - v)/usersMap[item.name][dates[i-1]])*100).toFixed(1);
                    delta = `<div style="font-size:0.6rem; color:var(--success)">${diff}%</div>`;
                }
                h2 += `<td>${v}${delta}</td>`;
            });
            h1 += `<td>${item.total}%</td></tr>`; h2 += `</tr>`;
        });
        document.getElementById("competitorTable").innerHTML = h1;
        document.getElementById("skipTable").innerHTML = h2;
    }

    function copyUPI() { navigator.clipboard.writeText("8431257887@ybl").then(() => alert("UPI Copied!")); }

    async function init() {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getAllWeights"})});
        const data = await res.json();
        if(data.length > 1) processData(data);
    }
    init();
</script>
</body>
</html>
