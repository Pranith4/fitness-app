<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="video-bg">
  <iframe src="https://www.youtube.com/embed/eAlNvWgTDZQ?autoplay=1&mute=1&loop=1&playlist=eAlNvWgTDZQ&controls=0" allow="autoplay"></iframe>
</div>

<div class="header">
  <h2 id="welcome"></h2>
  <button onclick="refreshAll()">ðŸ”„ Refresh</button>
</div>

<div class="card smallChart">
  <h3>Group Weight Trend</h3>
  <canvas id="groupChart"></canvas>
</div>

<div class="card">
  <h3>Weights by Date</h3>
  <table id="matrixTable"></table>
</div>

<div class="grid">

<div class="card">
  <h3>Add Today's Weight</h3>
  <input id="weight" placeholder="Enter weight">
  <button onclick="addWeight()">Submit</button>
  <p id="msg"></p>
</div>

<div class="card">
  <h3>ðŸŽ¯ Goal Planner</h3>
  <input id="startWeight" placeholder="Start Weight">
  <input id="targetWeight" placeholder="Target Weight">
  <input type="date" id="startDate">
  <input type="date" id="endDate">
  <button onclick="saveGoal()">Save Goal</button>

  <div id="goalStats">
    <p>Total Loss: <b id="totalLoss"></b></p>
    <p>Total Days: <b id="totalDays"></b></p>
    <p>Daily Required: <b id="dailyLoss"></b></p>
    <p>Expected Today: <b id="expectedToday"></b></p>
    <p>Status: <b id="goalStatus"></b></p>
  </div>
</div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

let groupChart,expectedGoalWeight=null;

async function loadGroupData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
if(data.length<=1) return;
const rows=data.slice(1);

let users={},datesSet=new Set();
rows.forEach(r=>{
let d=new Date(r[1]).toLocaleDateString();
datesSet.add(d);
if(!users[r[0]]) users[r[0]]=[];
users[r[0]].push({date:d,weight:parseFloat(r[2])});
});

const dates=[...datesSet].sort((a,b)=>new Date(a)-new Date(b));
let datasets=Object.keys(users).map(name=>({
label:name,
data:dates.map(d=>{let rec=users[name].find(x=>x.date===d);return rec?rec.weight:null;}),
tension:0.3
}));

if(groupChart)groupChart.destroy();
groupChart=new Chart(groupChart,{type:"line",data:{labels:dates,datasets}});

// table
let html="<tr><th>Name</th>"+dates.map(d=>`<th>${d}</th>`).join("")+"</tr>";
Object.keys(users).forEach(name=>{
html+="<tr><td>"+name+"</td>";
dates.forEach(d=>{
let rec=users[name].find(x=>x.date===d);
html+="<td>"+(rec?rec.weight:"-")+"</td>";
});
html+="</tr>";
});
matrixTable.innerHTML=html;
}

async function addWeight(){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
weight.value="";
refreshAll();
}

async function saveGoal(){
await fetch(API_URL,{method:"POST",body:JSON.stringify({
action:"saveGoal",username:user,startWeight:startWeight.value,targetWeight:targetWeight.value,startDate:startDate.value,endDate:endDate.value
})});
loadGoal();
}

async function loadGoal(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getGoal",username:user})});
const g=await res.json();
if(!g.startWeight) return;

const sw=parseFloat(g.startWeight);
const tw=parseFloat(g.targetWeight);
const sd=new Date(g.startDate);
const ed=new Date(g.endDate);

const totalDays=Math.ceil((ed-sd)/(1000*60*60*24));
const dailyLoss=(sw-tw)/totalDays;
const today=new Date();
const daysPassed=Math.ceil((today-sd)/(1000*60*60*24));
expectedGoalWeight=(sw-(dailyLoss*daysPassed));

totalLoss.innerText=(sw-tw).toFixed(1);
totalDays.innerText=totalDays;
dailyLoss.innerText=dailyLoss.toFixed(2);
expectedToday.innerText=expectedGoalWeight.toFixed(1);
goalStatus.innerText="Tracking...";
}

function refreshAll(){ loadGroupData(); loadGoal(); }

refreshAll();
</script>
</body>
</html>
