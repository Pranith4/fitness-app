<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Challenge Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="layout">
    <div class="main-content">
        <div class="card prize-hero">
            <h3>üèÜ TOTAL PRIZE POOL</h3>
            <h1 style="font-size: 3rem; margin: 0;">‚Çπ6,000</h1>
            <p>Leaderboard based on % Body Fat Loss</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Current Streak</span><h2 id="streakVal">0 Days</h2></div>
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeftVal">0</h2></div>
            <div class="stat-box"><span>Daily Target</span><h2 id="targetVal">0.0kg</h2></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3>üìà Group Performance</h3>
                <button onclick="refreshAll()" style="width:auto; padding:5px 15px">üîÑ Sync</button>
            </div>
            <canvas id="groupChart" height="120"></canvas>
        </div>

        <div class="card">
            <h3>üìä Weight Leaderboard</h3>
            <div style="overflow-x: auto;">
                <table id="matrixTable"></table>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="card">
            <h2 id="welcome"></h2>
            <p id="goalStatus" style="font-size: 0.9rem; color: var(--primary)"></p>
        </div>

        <div class="card">
            <h3>üéØ Goal Planner</h3>
            <input type="number" id="targetWeight" placeholder="Target Weight (kg)">
            <input type="date" id="endDate">
            <button onclick="saveGoal()">Update Goal</button>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <input type="number" step="0.1" id="weightInput" placeholder="Enter today's weight">
            <button onclick="addWeight()">Submit Entry</button>
        </div>

        <div class="card referral-box">
            <span style="color: var(--accent)">üíß Stay Hydrated!</span>
            <p style="font-size: 0.8rem">Pay to 8431257887@ybl for Motivation:</p>
            <strong style="letter-spacing: 2px;">INR 100</strong>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; // Ensure this is correct
const user = localStorage.getItem("user") || "Guest";
document.getElementById("welcome").innerText = "Hey, " + user + "!";

let groupChart;

// Custom Chart Styles
const chartOptions = {
    responsive: true,
    plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'Inter' } } } },
    scales: {
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
    }
};

async function loadGroupData() {
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action: "getAllWeights"})});
    const data = await res.json();
    if (data.length <= 1) return;

    const rows = data.slice(1);
    let users = {}, datesSet = new Set();

    rows.forEach(r => {
        let d = new Date(r[1]).toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        datesSet.add(d);
        if (!users[r[0]]) users[r[0]] = [];
        users[r[0]].push({date: d, weight: parseFloat(r[2])});
    });

    const dates = [...datesSet];
    const colors = ['#00f2fe', '#ff2e63', '#00ff88', '#f8ff00'];

    let datasets = Object.keys(users).map((name, i) => ({
        label: name,
        data: dates.map(d => users[name].find(x => x.date === d)?.weight || null),
        borderColor: colors[i % colors.length],
        backgroundColor: colors[i % colors.length] + '22',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 4
    }));

    if (groupChart) groupChart.destroy();
    groupChart = new Chart(document.getElementById("groupChart"), {
        type: "line",
        data: { labels: dates, datasets },
        options: chartOptions
    });

    updateTable(users, dates);
}

function updateTable(users, dates) {
    let html = `<tr><th>Athlete</th>${dates.map(d => `<th>${d}</th>`).join("")}<th>Progress</th></tr>`;
    
    Object.keys(users).forEach(name => {
        let weights = users[name].map(u => u.weight);
        let start = weights[0];
        let current = weights[weights.length-1];
        let diff = (start - current).toFixed(1);
        let pct = ((diff / start) * 100).toFixed(1);

        html += `<tr>
            <td style="font-weight:bold">${name}</td>
            ${dates.map(d => {
                let v = users[name].find(x => x.date === d)?.weight;
                return `<td>${v || '-'}</td>`;
            }).join("")}
            <td style="color:${diff >= 0 ? '#00ff88' : '#ff4d4d'}">
                ${diff}kg (${pct}%)
            </td>
        </tr>`;
    });
    document.getElementById("matrixTable").innerHTML = html;
}

// Logic for calculating streaks and goals remains similar but updates the new UI boxes
async function refreshAll() {
    await loadGroupData();
    // Logic for individual stats...
}

refreshAll();
</script>
</body>
</html>
