<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Fitness Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <p>Overall % fat loss wins the jackpot!</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeft">--</h2></div>
            <div class="stat-box"><span>Your Total Loss</span><h2 id="totalLoss">--</h2></div>
            <div class="stat-box"><span>Rank</span><h2 id="rank">--</h2></div>
        </div>

        <div class="card">
            <h3 style="color:var(--primary); margin-bottom:15px">‚öîÔ∏è Weekly Weight Matrix (Overall)</h3>
            <div class="table-container">
                <table id="competitorTable" class="matrix-table"></table>
            </div>
            <p class="table-note">* % Loss calculated from Initial Weight to Latest.</p>
        </div>

        <div class="card">
            <h3 style="color:var(--gold); margin-bottom:15px">üî• Skip 500 Challenge (Weekly Delta)</h3>
            <div class="table-container">
                <table id="skipTable" class="matrix-table"></table>
            </div>
            <p class="table-note">* % Loss calculated from Current vs Previous Week.</p>
        </div>
    </div>

    <div class="side-panel">
        <div class="card user-profile">
            <div class="avatar">‚ö°</div>
            <div>
                <h2 id="welcomeText">Athlete</h2>
                <button onclick="refreshAll()" class="sync-btn">üîÑ Sync Cloud Data</button>
            </div>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <div class="input-group">
                <input type="number" step="0.1" id="weightInput" placeholder="Weight in kg">
                <button onclick="addWeight()">Submit</button>
            </div>
            <p id="msg"></p>
        </div>

        <div class="card">
            <h3>üéØ Goal Settings</h3>
            <div class="goal-form">
                <input type="number" id="startW" placeholder="Start Weight">
                <input type="number" id="targetW" placeholder="Target Weight">
                <input type="date" id="endD">
                <button onclick="saveGoal()" class="outline-btn">Update Goal</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; 
const user = localStorage.getItem("user") || "Guest";
document.getElementById("welcomeText").innerText = user;

async function refreshAll() {
    const cachedGoal = localStorage.getItem(`goal_${user}`);
    const cachedLogs = localStorage.getItem(`logs_${user}`);
    if (cachedGoal) renderGoalData(JSON.parse(cachedGoal));
    if (cachedLogs) processAndRender(JSON.parse(cachedLogs));
    await Promise.all([loadGoal(), loadData()]);
}

// ... [addWeight, saveGoal, loadGoal, loadData, renderGoalData functions remain same as previous version] ...

async function addWeight() {
    const w = document.getElementById("weightInput").value;
    if(!w) return;
    const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"addWeight", username:user, weight:w})});
    const result = await res.json();
    document.getElementById("msg").innerText = result.success ? "‚úÖ Success!" : "‚ùå " + result.message;
    if(result.success) refreshAll();
}

async function saveGoal() {
    const data = { action: "saveGoal", username: user, startWeight: document.getElementById("startW").value, targetWeight: document.getElementById("targetW").value, endDate: document.getElementById("endD").value };
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify(data)});
    if((await res.json()).success) { alert("Goal Updated!"); refreshAll(); }
}

async function loadGoal() {
    const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getGoal", username:user})});
    const g = await res.json();
    if(g.targetWeight) { localStorage.setItem(`goal_${user}`, JSON.stringify(g)); renderGoalData(g); }
}

async function loadData() {
    const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getAllWeights"})});
    const data = await res.json();
    if(data && data.length > 1) { localStorage.setItem(`logs_${user}`, JSON.stringify(data)); processAndRender(data); }
}

function renderGoalData(g) {
    document.getElementById("targetW").value = g.targetWeight || "";
    document.getElementById("startW").value = g.startWeight || "";
    document.getElementById("endD").value = g.endDate ? g.endDate.split('T')[0] : "";
    if(g.endDate) {
        const days = Math.ceil((new Date(g.endDate) - new Date()) / (1000*60*60*24));
        document.getElementById("daysLeft").innerText = Math.max(0, days) + "d";
    }
}

function processAndRender(data) {
    const rows = data.slice(1);
    let usersMap = {}, weeklyDatesSet = new Set();

    rows.forEach(r => {
        const rawDate = new Date(r[1]);
        // Group by ISO Week
        const weekLabel = `Wk ${getWeekNumber(rawDate)}`;
        weeklyDatesSet.add(weekLabel);
        
        if(!usersMap[r[0]]) usersMap[r[0]] = {};
        // Only keep the latest entry for that week
        if(!usersMap[r[0]][weekLabel] || rawDate > usersMap[r[0]][weekLabel].rawDate) {
            usersMap[r[0]][weekLabel] = { weight: parseFloat(r[2]), rawDate: rawDate };
        }
    });

    const sortedWeeks = [...weeklyDatesSet].sort();
    renderOverallMatrix(usersMap, sortedWeeks);
    renderSkipChallenge(usersMap, sortedWeeks);
}

function renderOverallMatrix(usersMap, weeks) {
    let html = `<thead><tr><th class="sticky-col">Athlete</th>`;
    weeks.forEach(w => html += `<th>${w}</th>`);
    html += `<th class="sticky-right">Total %</th></tr></thead><tbody>`;
    
    Object.keys(usersMap).forEach(u => {
        const userWeeks = weeks.map(w => usersMap[u][w] ? usersMap[u][w].weight : null).filter(v => v !== null);
        const start = userWeeks[0];
        const latest = userWeeks[userWeeks.length - 1];
        const totalPct = (((start - latest) / start) * 100).toFixed(2);
        
        if(u === user) { document.getElementById("totalLoss").innerText = totalPct + "%"; }

        html += `<tr><td class="sticky-col name-cell">${u}</td>`;
        weeks.forEach(w => html += `<td>${usersMap[u][w]?.weight || '-'}</td>`);
        html += `<td class="sticky-right total-cell">${totalPct}%</td></tr>`;
    });
    document.getElementById("competitorTable").innerHTML = html;
}

function renderSkipChallenge(usersMap, weeks) {
    let html = `<thead><tr><th class="sticky-col">Athlete</th>`;
    weeks.forEach(w => html += `<th>${w}</th>`);
    html += `</tr></thead><tbody>`;
    
    Object.keys(usersMap).forEach(u => {
        html += `<tr><td class="sticky-col name-cell">${u}</td>`;
        weeks.forEach((w, i) => {
            const current = usersMap[u][w]?.weight;
            let deltaHtml = "";
            if(current && i > 0) {
                const prevWeek = weeks[i-1];
                const prevWeight = usersMap[u][prevWeek]?.weight;
                if(prevWeight) {
                    const diff = (((current - prevWeight)/prevWeight)*100).toFixed(1);
                    deltaHtml = `<div class="diff" style="color:${diff <= 0 ? '#00ff88' : '#ff4d4d'}">${diff}%</div>`;
                }
            }
            html += `<td>${current || '-'}${deltaHtml}</td>`;
        });
        html += `</tr>`;
    });
    document.getElementById("skipTable").innerHTML = html;
}

function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7);
}

refreshAll();
</script>
</body>
</html>
