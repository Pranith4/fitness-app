<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

let dailyChartInstance, monthlyChartInstance, goalChartInstance;
let expectedGoalWeight=null;

function toggleForm(){ formCard.classList.toggle("hidden"); }
function refreshData(){ loadData(); }

async function loadData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const rows=await res.json();

if(rows.length===0){noData.classList.remove("hidden");return;}
noData.classList.add("hidden");

const dates=rows.map(r=>new Date(r[1]));
const weights=rows.map(r=>parseFloat(r[2]));
let labels=dates.map(d=>d.toLocaleDateString());

if(expectedGoalWeight!==null){
const current=weights[weights.length-1];
goalStatus.innerText=current<=expectedGoalWeight?"On Track ✅":"Behind ⚠️";
}

if(dailyChartInstance) dailyChartInstance.destroy();
dailyChartInstance=new Chart(dailyChart,{type:"line",data:{labels:labels,datasets:[{label:"Weight",data:weights,tension:0.3}]}});

loadLeaderboard();
}

async function loadLeaderboard(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
const rows=data.slice(1);
let users={};

rows.forEach(r=>{
if(!users[r[0]]) users[r[0]]=[];
users[r[0]].push({date:new Date(r[1]),weight:parseFloat(r[2])});
});

let results=[];
Object.keys(users).forEach(name=>{
const rec=users[name].sort((a,b)=>a.date-b.date);
results.push({
name,
initial:rec[0].weight,
latest:rec[rec.length-1].weight,
percent:((rec[0].weight-rec[rec.length-1].weight)/rec[0].weight*100).toFixed(2)
});
});

results.sort((a,b)=>b.percent-a.percent);
leaderboard.innerHTML="";
results.forEach((r,i)=>leaderboard.innerHTML+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.initial}</td><td>${r.latest}</td><td>${r.percent}%</td></tr>`);
}

async function saveGoal(){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"saveGoal",username:user,startWeight:startWeight.value,targetWeight:targetWeight.value,startDate:startDate.value,endDate:endDate.value})});
loadGoal();
}

async function loadGoal(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getGoal",username:user})});
const g=await res.json();

if(!g.startWeight){goalForm.classList.remove("hidden");goalStats.classList.add("hidden");return;}

startWeight.value=g.startWeight;
targetWeight.value=g.targetWeight;
startDate.value=g.startDate;
endDate.value=g.endDate;
goalForm.classList.add("hidden");
calculateGoalStats();
}

function calculateGoalStats(){
const sw=parseFloat(startWeight.value);
const tw=parseFloat(targetWeight.value);
const sd=new Date(startDate.value);
const ed=new Date(endDate.value);
const today=new Date();

const totalDays=Math.ceil((ed-sd)/(1000*60*60*24));
const dailyLoss=((sw-tw)/totalDays);
const daysPassed=Math.ceil((today-sd)/(1000*60*60*24));
expectedGoalWeight=(sw-(dailyLoss*daysPassed));

totalLoss.innerText=(sw-tw).toFixed(1);
totalDays.innerText=totalDays;
dailyLoss.innerText=dailyLoss.toFixed(2);
expectedToday.innerText=expectedGoalWeight.toFixed(1);

goalStats.classList.remove("hidden");
}

function resetGoal(){goalForm.classList.remove("hidden");goalStats.classList.add("hidden");expectedGoalWeight=null;}

loadData();
loadGoal();
setInterval(loadData,30000);
</script>
