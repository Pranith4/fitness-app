<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- ðŸŽ¥ VIDEO -->
<div class="video-bg">
<iframe src="https://www.youtube.com/embed/eAlNvWgTDZQ?autoplay=1&mute=1&loop=1&playlist=eAlNvWgTDZQ&controls=0" allow="autoplay"></iframe>
</div>

<div class="header">
<h2 id="welcome"></h2>
<button onclick="refreshAll()">ðŸ”„ Refresh</button>
</div>

<div class="tabs">
<button onclick="showTab('overview')" id="overviewTab" class="activeTab">Overview</button>
<button onclick="showTab('personal')" id="personalTab">My Journey</button>
</div>

<!-- ðŸŒ OVERVIEW -->
<div id="overviewSection">
<div class="card"><h3>Group Trend</h3><canvas id="groupChart"></canvas></div>
<div class="card">
<h3>Weights by Date</h3>
<table id="matrixTable"></table>
</div>
</div>

<!-- ðŸ‘¤ PERSONAL -->
<div id="personalSection" class="hidden">
<div class="grid">

<div class="card">
<h3>Your Trend</h3>
<canvas id="userChart"></canvas>

<h3>Daily Log</h3>
<table id="userTable"></table>
</div>

<div class="card">
<h3>ðŸŽ¯ Goal Planner</h3>
<div id="goalForm">
<input id="startWeight" placeholder="Start Weight">
<input id="targetWeight" placeholder="Target Weight">
<input type="date" id="startDate">
<input type="date" id="endDate">
<button onclick="saveGoal()">Save Goal</button>
</div>

<div id="goalStats" class="hidden">
<p>Total Loss: <b id="totalLoss"></b></p>
<p>Days: <b id="totalDays"></b></p>
<p>Daily Required: <b id="dailyLoss"></b></p>
<p>Expected Today: <b id="expectedToday"></b></p>
<p>Status: <b id="goalStatus"></b></p>
<button onclick="resetGoal()">Reset</button>
</div>
</div>

</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
welcome.innerText="Welcome, "+user;

let groupChart,userChart;

function showTab(tab){
overviewSection.classList.toggle("hidden",tab!=='overview');
personalSection.classList.toggle("hidden",tab!=='personal');
overviewTab.classList.toggle("activeTab",tab==='overview');
personalTab.classList.toggle("activeTab",tab==='personal');
}

async function refreshAll(){
loadGroupData();
loadUserData();
loadGoal();
}

async function loadGroupData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
const rows=data.slice(1);

let users={},datesSet=new Set();
rows.forEach(r=>{
datesSet.add(new Date(r[1]).toLocaleDateString());
if(!users[r[0]]) users[r[0]]=[];
users[r[0]].push({date:new Date(r[1]).toLocaleDateString(),weight:r[2]});
});

const dates=[...datesSet].sort((a,b)=>new Date(a)-new Date(b));

let datasets=Object.keys(users).map(name=>{
return {
label:name,
data:dates.map(d=>{
let rec=users[name].find(x=>x.date===d);
return rec?rec.weight:null;
}),
tension:0.3
};
});

if(groupChart)groupChart.destroy();
groupChart=new Chart(groupChartCanvas,{type:"line",data:{labels:dates,datasets}});

// table
let html="<tr><th>Name</th>"+dates.map(d=>`<th>${d}</th>`).join("")+"</tr>";
Object.keys(users).forEach(name=>{
html+="<tr><td>"+name+"</td>";
dates.forEach(d=>{
let rec=users[name].find(x=>x.date===d);
html+="<td>"+(rec?rec.weight:"-")+"</td>";
});
html+="</tr>";
});
matrixTable.innerHTML=html;
}

async function loadUserData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const rows=await res.json();
if(rows.length===0)return;

const dates=rows.map(r=>new Date(r[1]).toLocaleDateString());
const weights=rows.map(r=>r[2]);

if(userChart)userChart.destroy();
userChart=new Chart(userChartCanvas,{type:"line",data:{labels:dates,datasets:[{label:"Weight",data:weights,tension:0.3}]}});

let html="<tr><th>Date</th><th>Weight</th></tr>";
rows.forEach(r=>html+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td></tr>`);
userTable.innerHTML=html;
}

// Goal logic same as before (saveGoal, loadGoal, calculateGoalStats)

refreshAll();
</script>
</body>
</html>
