<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
  <h2 id="welcome"></h2>
  <button onclick="toggleForm()">+ Add Weight</button>
</div>

<div id="formCard" class="card hidden">
  <input id="weight" placeholder="Enter weight">
  <button onclick="addWeight()">Submit</button>
  <p id="msg"></p>
</div>

<div id="noData" class="centerMsg hidden">No data yet. Add weight to see graphs ðŸ“ˆ</div>

<div class="grid">
  <div class="card"><h3>Daily Progress</h3><canvas id="dailyChart"></canvas></div>
  <div class="card"><h3>Monthly Avg</h3><canvas id="monthlyChart"></canvas></div>
</div>

<div class="card">
  <h3>Leaderboard (Latest Weight)</h3>
  <ul id="leaderboard"></ul>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

function toggleForm(){ formCard.classList.toggle("hidden"); }

async function loadData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const data=await res.json();

if(data.length<=1){
noData.classList.remove("hidden");
return;
}

noData.classList.add("hidden");
const rows=data.slice(1);

const dates=rows.map(r=>new Date(r[1]).toLocaleDateString());
const weights=rows.map(r=>parseFloat(r[2]));

new Chart(dailyChart,{type:"line",data:{labels:dates,datasets:[{label:"Weight",data:weights,tension:0.3}]}});

let monthData={};
rows.forEach(r=>{
let m=new Date(r[1]).toLocaleString('default',{month:'short'});
if(!monthData[m]) monthData[m]=[];
monthData[m].push(parseFloat(r[2]));
});
let months=Object.keys(monthData);
let avg=months.map(m=>monthData[m].reduce((a,b)=>a+b)/monthData[m].length);
new Chart(monthlyChart,{type:"bar",data:{labels:months,datasets:[{label:"Avg Weight",data:avg}]}});

loadLeaderboard();
}

async function loadLeaderboard(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
let latest={};
data.slice(1).forEach(r=>latest[r[0]]=r[2]);
leaderboard.innerHTML="";
Object.entries(latest).sort((a,b)=>a[1]-b[1]).forEach(e=>{
leaderboard.innerHTML+=`<li>${e[0]} â€” ${e[1]} kg</li>`;
});
}

async function addWeight(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
const d=await res.json();
msg.innerText=d.success?`âœ… Submitted at ${new Date(d.timestamp).toLocaleString()}`:`âš  ${d.message}`;
weight.value="";
loadData();
}

loadData();
</script>
</body>
</html>
