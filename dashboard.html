<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Challenge Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <p>Top % Fat Loss takes the crown</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <span>Days Remaining</span>
                <h2 id="daysLeftVal">--</h2>
            </div>
            <div class="stat-box">
                <span>Required/Day</span>
                <h2 id="targetVal">--</h2>
            </div>
            <div class="stat-box">
                <span>Personal Progress</span>
                <h2 id="personalLossVal">--</h2>
            </div>
        </div>

        <div class="card">
            <h3>üìà Group Performance Trend</h3>
            <canvas id="groupChart" height="120"></canvas>
        </div>

        <div class="card">
            <h3>‚öîÔ∏è Competitor Daily Delta</h3>
            <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom:15px;">Daily weight and % change from their previous log</p>
            <div style="overflow-x: auto;">
                <table id="competitorTable" class="matrix-table"></table>
            </div>
        </div>

        <div class="card">
            <h3>üìú Your Personal Logs</h3>
            <div style="overflow-x: auto;">
                <table id="historyTable" class="history-table"></table>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card profile-card">
            <h2 id="welcomeText">Athlete</h2>
            <button onclick="refreshAll()" class="btn-refresh">üîÑ Sync Data</button>
        </div>

    <div class="card motivation-card shine">
    <h3>Stay Motivated üî•</h3>
    <p>Fuel the hustle and keep the streak alive!</p>
    <div class="upi-box">
        <span>Pay INR 100 to:</span>
        <strong id="upiId">8431257887@ybl</strong>
    </div>
    <button class="btn-copy" onclick="copyUPI()">Copy UPI ID</button>
</div>
        
        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <div class="input-group">
                <input type="number" step="0.1" id="weightInput" placeholder="Current kg">
                <button onclick="addWeight()" class="btn-primary">Submit</button>
            </div>
            <p id="msg" style="font-size:0.8rem; margin-top:8px; text-align:center;"></p>
        </div>

        <div class="card goal-card">
            <h3>üéØ Set Strategy</h3>
            <div class="goal-form">
                <label>Starting Weight (kg)</label>
                <input type="number" id="startW">
                
                <label>Target Weight (kg)</label>
                <input type="number" id="targetW">
                
                <label>Target Date</label>
                <input type="date" id="endD">
                
                <button onclick="saveGoal()" class="btn-secondary">Update Goal</button>
            </div>
        </div>
    </div>
</div>

<script>
/** CONFIGURATION **/
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; // PASTE YOUR URL HERE
const user = localStorage.getItem("user") || "Guest";
document.getElementById("welcomeText").innerText = user;

let groupChart;

/** CORE FUNCTIONS **/
async function refreshAll() {
    await loadGoal();
    await loadDataAndTables();
}

async function addWeight() {
    const w = document.getElementById("weightInput").value;
    if(!w) return;
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"addWeight", username:user, weight:w})});
    const result = await res.json();
    const msgEl = document.getElementById("msg");
    msgEl.innerText = result.success ? "‚úÖ Logged!" : "‚ùå " + result.message;
    msgEl.style.color = result.success ? "#00ff88" : "#ff4d4d";
    if(result.success) refreshAll();
}

async function saveGoal() {
    const data = {
        action: "saveGoal",
        username: user,
        startWeight: document.getElementById("startW").value,
        targetWeight: document.getElementById("targetW").value,
        startDate: new Date().toISOString().split('T')[0],
        endDate: document.getElementById("endD").value
    };
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify(data)});
    const result = await res.json();
    if(result.success) { alert("Goal Updated!"); refreshAll(); }
}

async function loadGoal() {
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"getGoal", username:user})});
    const g = await res.json();
    if(!g.targetWeight) return;

    document.getElementById("startW").value = g.startWeight;
    document.getElementById("targetW").value = g.targetWeight;
    document.getElementById("endD").value = g.endDate ? g.endDate.split('T')[0] : "";

    const today = new Date();
    const end = new Date(g.endDate);
    const daysLeft = Math.ceil((end - today) / (1000*60*60*24));
    document.getElementById("daysLeftVal").innerText = Math.max(0, daysLeft) + " Days";
}

async function loadDataAndTables() {
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify({action:"getAllWeights"})});
    const data = await res.json();
    if (data.length <= 1) return;
    
    const rows = data.slice(1);
    let usersMap = {}, datesSet = new Set();

    rows.forEach(r => {
        let dateObj = new Date(r[1]);
        let dKey = dateObj.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        datesSet.add(dKey);
        if(!usersMap[r[0]]) usersMap[r[0]] = [];
        usersMap[r[0]].push({ date: dKey, weight: parseFloat(r[2]), rawDate: dateObj });
    });

    const sortedDates = [...datesSet];
    
    renderGroupChart(usersMap, sortedDates);
    renderCompetitorTable(usersMap, sortedDates);
    renderPersonalHistory(usersMap[user] || []);
}

/** RENDERING ENGINES **/
function renderGroupChart(usersMap, dates) {
    const colors = ['#4facfe', '#ff2e63', '#00ff88', '#f8ff00', '#ae7aff'];
    const datasets = Object.keys(usersMap).map((name, i) => ({
        label: name,
        data: dates.map(d => usersMap[name].find(x => x.date === d)?.weight || null),
        borderColor: colors[i % colors.length],
        tension: 0.3,
        borderWidth: 3,
        spanGaps: true
    }));

    if(groupChart) groupChart.destroy();
    groupChart = new Chart(document.getElementById("groupChart"), {
        type: 'line',
        data: { labels: dates, datasets },
        options: { 
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } },
            scales: { 
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                x: { ticks: { color: '#94a3b8' } }
            }
        }
    });
}

function renderCompetitorTable(usersMap, dates) {
    let html = `<tr><th>Athlete</th>`;
    dates.forEach(d => html += `<th>${d}</th>`);
    html += `<th>Total Loss</th></tr>`;

    Object.keys(usersMap).forEach(name => {
        html += `<tr><td style="font-weight:bold; color:#4facfe">${name}</td>`;
        let entries = usersMap[name];
        
        dates.forEach((d, idx) => {
            let entry = entries.find(x => x.date === d);
            if (entry) {
                let diffHtml = "";
                // Calculate Delta from previous recorded log
                let prevEntries = entries.filter(x => new Date(x.rawDate) < new Date(entry.rawDate));
                if (prevEntries.length > 0) {
                    let prevWeight = prevEntries[prevEntries.length - 1].weight;
                    let dailyDiff = (((entry.weight - prevWeight) / prevWeight) * 100).toFixed(1);
                    let color = dailyDiff <= 0 ? "#00ff88" : "#ff4d4d";
                    diffHtml = `<br><span style="font-size:0.7rem; color:${color}">${dailyDiff > 0 ? '+' : ''}${dailyDiff}%</span>`;
                }
                html += `<td>${entry.weight}${diffHtml}</td>`;
            } else {
                html += `<td style="color:#444">-</td>`;
            }
        });

        const start = entries[0].weight;
        const latest = entries[entries.length-1].weight;
        const totalPct = (((start - latest) / start) * 100).toFixed(2);
        html += `<td style="font-weight:bold; background:rgba(0,255,136,0.1)">${totalPct}%</td></tr>`;
        
        if(name === user) document.getElementById("personalLossVal").innerText = totalPct + "%";
    });
    document.getElementById("competitorTable").innerHTML = html;
}

function renderPersonalHistory(history) {
    if (!history.length) return;
    let sorted = [...history].sort((a,b) => b.rawDate - a.rawDate);
    let html = `<tr><th>Date</th><th>Weight</th><th>Status</th></tr>`;
    sorted.forEach((entry, i) => {
        let status = "‚ûñ";
        if (i < sorted.length - 1) {
            let prev = sorted[i+1].weight;
            status = entry.weight < prev ? "üìâ Down" : (entry.weight > prev ? "üìà Up" : "‚ûñ");
        }
        html += `<tr><td>${entry.date}</td><td>${entry.weight} kg</td><td>${status}</td></tr>`;
    });
    document.getElementById("historyTable").innerHTML = html;
}

// Initial Load
refreshAll();
</script>
</body>
</html>
