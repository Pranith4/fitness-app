<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Fitness Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <p>Top % fat loss wins the jackpot!</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeft">--</h2></div>
            <div class="stat-box"><span>Your Total Loss</span><h2 id="totalLoss">--</h2></div>
            <div class="stat-box"><span>Rank</span><h2 id="rank">--</h2></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 style="color:var(--primary)">‚öîÔ∏è Competitor Weight Matrix</h3>
            </div>
            <div class="table-container">
                <table id="competitorTable" class="matrix-table"></table>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card user-profile">
            <div class="avatar">‚ö°</div>
            <div>
                <h2 id="welcomeText">Athlete</h2>
                <button onclick="refreshAll()" class="sync-btn">üîÑ Sync Cloud Data</button>
            </div>
        </div>

        <div class="card motivation-card shine">
            <h3 style="color:var(--gold)">Stay Motivated üî•</h3>
            <p>Fuel the challenge!</p>
            <div class="upi-box">
                <span>Contribution for Pool/Motivation:</span>
                <span class="upi-id" id="upiValue">8431257887@ybl</span>
            </div>
            <button onclick="copyUPI()" class="gold-btn">Copy UPI ID</button>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Daily Weight</h3>
            <div class="input-group">
                <input type="number" step="0.1" id="weightInput" placeholder="Current weight in kg">
                <button onclick="addWeight()">Submit</button>
            </div>
            <p id="msg"></p>
        </div>

        <div class="card">
            <h3>üìú Personal History</h3>
            <div class="table-container-mini">
                <table id="historyTable"></table>
            </div>
        </div>
        
        <div class="card">
            <h3>üéØ Goal Settings</h3>
            <div class="goal-form">
                <label>Start Weight</label>
                <input type="number" id="startW">
                <label>Target Weight</label>
                <input type="number" id="targetW">
                <label>End Date</label>
                <input type="date" id="endD">
                <button onclick="saveGoal()" class="outline-btn">Update Goal</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; 
const user = localStorage.getItem("user") || "Guest";
document.getElementById("welcomeText").innerText = user;

async function refreshAll() {
    const cachedGoal = localStorage.getItem(`goal_${user}`);
    const cachedLogs = localStorage.getItem(`logs_${user}`);

    if (cachedGoal) renderGoalData(JSON.parse(cachedGoal));
    if (cachedLogs) processAndRender(JSON.parse(cachedLogs));

    await Promise.all([loadGoal(), loadData()]);
}

async function addWeight() {
    const w = document.getElementById("weightInput").value;
    if(!w) return;
    const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"addWeight", username:user, weight:w})});
    const result = await res.json();
    const msg = document.getElementById("msg");
    msg.innerText = result.success ? "‚úÖ Logged Successfully!" : "‚ùå " + result.message;
    msg.className = result.success ? "success-text" : "error-text";
    if(result.success) refreshAll();
}

async function saveGoal() {
    const data = {
        action: "saveGoal",
        username: user,
        startWeight: document.getElementById("startW").value,
        targetWeight: document.getElementById("targetW").value,
        startDate: new Date().toISOString().split('T')[0],
        endDate: document.getElementById("endD").value
    };
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify(data)});
    const result = await res.json();
    if(result.success) { 
        alert("Goal Updated! üî•"); 
        refreshAll(); 
    }
}

async function loadGoal() {
    try {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getGoal", username:user})});
        const g = await res.json();
        if(g.targetWeight) {
            localStorage.setItem(`goal_${user}`, JSON.stringify(g));
            renderGoalData(g);
        }
    } catch(e) { console.error("Goal fetch failed", e); }
}

async function loadData() {
    try {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getAllWeights"})});
        const data = await res.json();
        if(data && data.length > 1) {
            localStorage.setItem(`logs_${user}`, JSON.stringify(data));
            processAndRender(data);
        }
    } catch(e) { console.error("Data fetch failed", e); }
}

function renderGoalData(g) {
    document.getElementById("targetW").value = g.targetWeight || "";
    document.getElementById("startW").value = g.startWeight || "";
    document.getElementById("endD").value = g.endDate ? g.endDate.split('T')[0] : "";
    
    if(g.endDate) {
        const days = Math.ceil((new Date(g.endDate) - new Date()) / (1000*60*60*24));
        document.getElementById("daysLeft").innerText = Math.max(0, days) + "d";
    }
}

function processAndRender(data) {
    const rows = data.slice(1);
    let usersMap = {}, datesSet = new Set();

    rows.forEach(r => {
        let d = new Date(r[1]).toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        datesSet.add(d);
        if(!usersMap[r[0]]) usersMap[r[0]] = [];
        usersMap[r[0]].push({date:d, weight:parseFloat(r[2]), rawDate: new Date(r[1])});
    });

    const dates = [...datesSet].sort((a,b) => new Date(a) - new Date(b));
    renderCompetitorTable(usersMap, dates);
    renderPersonalHistory(usersMap[user] || []);
}

function renderCompetitorTable(usersMap, dates) {
    let html = `<thead><tr><th class="sticky-col">Athlete</th>`;
    dates.forEach(d => html += `<th>${d}</th>`);
    html += `<th class="sticky-right">Total %</th></tr></thead><tbody>`;
    
    let leaderboard = Object.keys(usersMap).map(u => {
        let entries = usersMap[u].sort((a,b) => a.rawDate - b.rawDate);
        let start = entries[0].weight;
        let latest = entries[entries.length-1].weight;
        let pct = (((start - latest) / start) * 100).toFixed(2);
        return { name: u, entries, pct };
    }).sort((a,b) => b.pct - a.pct);

    leaderboard.forEach((item, idx) => {
        if(item.name === user) {
            document.getElementById("totalLoss").innerText = item.pct + "%";
            document.getElementById("rank").innerText = "#" + (idx + 1);
        }
        
        const rowClass = item.name === user ? "highlight-row" : "";
        html += `<tr class="${rowClass}"><td class="sticky-col name-cell">${item.name}</td>`;
        
        dates.forEach((d) => {
            let entry = item.entries.find(x => x.date === d);
            if(entry) {
                let deltaHtml = "";
                let prevEntries = item.entries.filter(x => x.rawDate < entry.rawDate);
                if(prevEntries.length > 0) {
                    let prevWeight = prevEntries[prevEntries.length - 1].weight;
                    let diff = (((entry.weight - prevWeight)/prevWeight)*100).toFixed(1);
                    let color = diff <= 0 ? "#00ff88" : "#ff4d4d";
                    deltaHtml = `<div class="diff" style="color:${color}">${diff > 0 ? '+' : ''}${diff}%</div>`;
                }
                html += `<td>${entry.weight}${deltaHtml}</td>`;
            } else html += `<td class="empty">-</td>`;
        });
        html += `<td class="sticky-right total-cell">${item.pct}%</td></tr>`;
    });
    html += `</tbody>`;
    document.getElementById("competitorTable").innerHTML = html;
}

function renderPersonalHistory(history) {
    let sorted = [...history].sort((a,b) => b.rawDate - a.rawDate);
    let html = `<thead><tr><th style="text-align:left">Date</th><th>Weight</th><th>Trend</th></tr></thead><tbody>`;
    sorted.forEach((entry, i) => {
        let trend = "‚ûñ";
        if(i < sorted.length-1) trend = entry.weight < sorted[i+1].weight ? "üìâ" : "üìà";
        html += `<tr><td style="text-align:left">${entry.date}</td><td>${entry.weight}</td><td>${trend}</td></tr>`;
    });
    html += `</tbody>`;
    document.getElementById("historyTable").innerHTML = html;
}

function copyUPI() {
    const upiText = document.getElementById("upiValue").innerText;
    navigator.clipboard.writeText(upiText).then(() => alert("UPI ID Copied! üî•"));
}

refreshAll();
</script>
</body>
</html>
