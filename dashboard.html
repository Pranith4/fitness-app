<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Fitness Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <p>Overall % fat loss wins the jackpot!</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeft">--</h2></div>
            <div class="stat-box"><span>Your Total Loss</span><h2 id="totalLoss">--</h2></div>
            <div class="stat-box"><span>Rank</span><h2 id="rank">--</h2></div>
        </div>

        <div class="card">
            <h3 style="color:var(--primary); margin-bottom:15px">‚öîÔ∏è Weekly Weight Matrix (Overall)</h3>
            <div class="table-container">
                <table id="competitorTable" class="matrix-table"></table>
            </div>
        </div>

        <div class="card">
            <h3 style="color:var(--gold); margin-bottom:15px">üî• Skip 500 Challenge (Week-on-Week)</h3>
            <div class="table-container">
                <table id="skipTable" class="matrix-table"></table>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card user-profile">
            <div class="avatar">‚ö°</div>
            <div>
                <h2 id="welcomeText">Athlete</h2>
                <button onclick="refreshAll()" class="outline-btn" style="padding:4px 8px; font-size:0.7rem; margin-top:5px">üîÑ Sync Data</button>
            </div>
        </div>

        <div class="card motivation-card">
            <h3 style="color:var(--gold)">Motivation üî•</h3>
            <div class="upi-box">
                <span>Contribute to Pool:</span>
                <span class="upi-id" id="upiValue">8431257887@ybl</span>
            </div>
            <button onclick="copyUPI()" style="background:var(--gold)">Copy UPI ID</button>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Weight (Mondays Only)</h3>
            <input type="number" step="0.1" id="weightInput" placeholder="Enter kg">
            <button onclick="addWeight()">Submit Entry</button>
            <p id="msg"></p>
        </div>

        <div class="card">
            <h3>üéØ Goal Settings</h3>
            <input type="number" id="startW" placeholder="Start Weight">
            <input type="number" id="targetW" placeholder="Target Weight">
            <input type="date" id="endD">
            <button onclick="saveGoal()" class="outline-btn">Update Goal</button>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec"; 
const user = localStorage.getItem("user") || "Guest";
document.getElementById("welcomeText").innerText = user;

async function refreshAll() {
    const cachedGoal = localStorage.getItem(`goal_${user}`);
    const cachedLogs = localStorage.getItem(`logs_${user}`);
    if (cachedGoal) renderGoalData(JSON.parse(cachedGoal));
    if (cachedLogs) processAndRender(JSON.parse(cachedLogs));
    await Promise.all([loadGoal(), loadData()]);
}

async function addWeight() {
    const msg = document.getElementById("msg");
    const weight = document.getElementById("weightInput").value;
    
    // MONDAY CHECK: 1 = Monday
    if (new Date().getDay() !== 1) {
        msg.innerText = "‚ùå Logging is only allowed on Mondays!";
        msg.className = "error-text";
        return;
    }

    if(!weight) { msg.innerText = "‚ö†Ô∏è Enter weight first"; return; }

    const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"addWeight", username:user, weight:weight})});
    const result = await res.json();
    msg.innerText = result.success ? "‚úÖ Logged successfully!" : "‚ùå " + result.message;
    msg.className = result.success ? "success-text" : "error-text";
    if(result.success) { document.getElementById("weightInput").value = ""; refreshAll(); }
}

async function saveGoal() {
    const data = { action: "saveGoal", username: user, startWeight: document.getElementById("startW").value, targetWeight: document.getElementById("targetW").value, endDate: document.getElementById("endD").value };
    const res = await fetch(API_URL, {method: "POST", body: JSON.stringify(data)});
    if((await res.json()).success) { alert("Goal Updated!"); refreshAll(); }
}

async function loadGoal() {
    try {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getGoal", username:user})});
        const g = await res.json();
        if(g.targetWeight) { localStorage.setItem(`goal_${user}`, JSON.stringify(g)); renderGoalData(g); }
    } catch(e) {}
}

async function loadData() {
    try {
        const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getAllWeights"})});
        const data = await res.json();
        if(data && data.length > 1) { localStorage.setItem(`logs_${user}`, JSON.stringify(data)); processAndRender(data); }
    } catch(e) {}
}

function renderGoalData(g) {
    document.getElementById("targetW").value = g.targetWeight || "";
    document.getElementById("startW").value = g.startWeight || "";
    document.getElementById("endD").value = g.endDate ? g.endDate.split('T')[0] : "";
    if(g.endDate) {
        const days = Math.ceil((new Date(g.endDate) - new Date()) / (1000*60*60*24));
        document.getElementById("daysLeft").innerText = Math.max(0, days) + "d";
    }
}

function processAndRender(data) {
    const rows = data.slice(1);
    let usersMap = {}, datesSet = new Set();

    rows.forEach(r => {
        const rawDate = new Date(r[1]);
        const monday = new Date(rawDate);
        monday.setDate(monday.getDate() - monday.getDay() + (monday.getDay() === 0 ? -6 : 1));
        const dateLabel = monday.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        
        datesSet.add(dateLabel);
        if(!usersMap[r[0]]) usersMap[r[0]] = {};
        if(!usersMap[r[0]][dateLabel] || rawDate > usersMap[r[0]][dateLabel].rawDate) {
            usersMap[r[0]][dateLabel] = { weight: parseFloat(r[2]), rawDate: rawDate };
        }
    });

    const sortedDates = [...datesSet].sort((a, b) => new Date(a) - new Date(b));
    renderTables(usersMap, sortedDates);
}

function renderTables(usersMap, dates) {
    let matrixHtml = `<thead><tr><th class="sticky-col">Athlete</th>`;
    let skipHtml = `<thead><tr><th class="sticky-col">Athlete</th>`;
    dates.forEach(d => { matrixHtml += `<th>${d}</th>`; skipHtml += `<th>${d}</th>`; });
    matrixHtml += `<th class="sticky-right">Total %</th></tr></thead><tbody>`;
    skipHtml += `</tr></thead><tbody>`;

    Object.keys(usersMap).forEach(u => {
        const userEntries = dates.map(d => usersMap[u][d] ? usersMap[u][d].weight : null).filter(v => v !== null);
        const totalPct = (((userEntries[0] - userEntries[userEntries.length-1]) / userEntries[0]) * 100).toFixed(2);
        
        if(u === user) { 
            document.getElementById("totalLoss").innerText = totalPct + "%";
            document.getElementById("rank").innerText = "#Calculating..."; // Add logic if rank needed
        }

        matrixHtml += `<tr><td class="sticky-col name-cell">${u}</td>`;
        skipHtml += `<tr><td class="sticky-col name-cell">${u}</td>`;

        dates.forEach((d, i) => {
            const current = usersMap[u][d]?.weight || '-';
            matrixHtml += `<td>${current}</td>`;
            
            let delta = "";
            if(usersMap[u][d] && i > 0) {
                const prev = usersMap[u][dates[i-1]]?.weight;
                if(prev) {
                    const diff = (((usersMap[u][d].weight - prev)/prev)*100).toFixed(1);
                    delta = `<div class="diff" style="color:${diff <= 0 ? '#00ff88' : '#ff4d4d'}">${diff}%</div>`;
                }
            }
            skipHtml += `<td>${current}${delta}</td>`;
        });

        matrixHtml += `<td class="sticky-right total-cell">${totalPct}%</td></tr>`;
        skipHtml += `</tr>`;
    });

    document.getElementById("competitorTable").innerHTML = matrixHtml;
    document.getElementById("skipTable").innerHTML = skipHtml;
}

function copyUPI() {
    navigator.clipboard.writeText(document.getElementById("upiValue").innerText).then(() => alert("UPI ID Copied!"));
}

refreshAll();
</script>
</body>
</html>
