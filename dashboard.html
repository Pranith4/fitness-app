<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
  <h2 id="welcome"></h2>
  <div>
    <button onclick="refreshData()">üîÑ Refresh</button>
    <button onclick="toggleForm()">+ Add Weight</button>
  </div>
</div>

<div id="formCard" class="card hidden">
  <input id="weight" placeholder="Enter weight">
  <button onclick="addWeight()">Submit</button>
  <p id="msg"></p>
</div>

<div id="noData" class="centerMsg hidden">No data yet. Add weight üìà</div>

<div class="grid">
  <div class="card"><h3>Daily Progress</h3><canvas id="dailyChart"></canvas></div>
  <div class="card"><h3>Monthly Avg</h3><canvas id="monthlyChart"></canvas></div>
</div>

<div class="card">
  <h3>üèÜ Leaderboard</h3>
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Start</th>
        <th>Current</th>
        <th>% Change</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

let dailyChartInstance;
let monthlyChartInstance;

function toggleForm(){ formCard.classList.toggle("hidden"); }

function refreshData(){
  msg.innerText="Refreshing...";
  loadData();
}

async function loadData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const data=await res.json();

if(data.length<=1){
  noData.classList.remove("hidden");
  return;
}
noData.classList.add("hidden");

const rows=data.slice(1);
const dates=rows.map(r=>new Date(r[1]));
const weights=rows.map(r=>parseFloat(r[2]));

let labels=dates.map(d=>d.toLocaleDateString());

if(dailyChartInstance) dailyChartInstance.destroy();
dailyChartInstance=new Chart(dailyChart,{type:"line",
data:{labels:labels,datasets:[{label:"Weight",data:weights,tension:0.3}]} });

let monthData={};
rows.forEach(r=>{
let m=new Date(r[1]).toLocaleString('default',{month:'short'});
if(!monthData[m]) monthData[m]=[];
monthData[m].push(parseFloat(r[2]));
});

if(monthlyChartInstance) monthlyChartInstance.destroy();
monthlyChartInstance=new Chart(monthlyChart,{type:"bar",
data:{labels:Object.keys(monthData),
datasets:[{label:"Avg",data:Object.values(monthData).map(a=>a.reduce((x,y)=>x+y)/a.length)}]}});

loadLeaderboard();
}

async function loadLeaderboard(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
const rows=data.slice(1);

let users={};
rows.forEach(r=>{
const name=r[0];
const weight=parseFloat(r[2]);
const date=new Date(r[1]);
if(!users[name]) users[name]=[];
users[name].push({date,weight});
});

let results=[];
Object.keys(users).forEach(name=>{
const rec=users[name].sort((a,b)=>a.date-b.date);
const initial=rec[0].weight;
const latest=rec[rec.length-1].weight;
const percent=((initial-latest)/initial*100).toFixed(2);
results.push({name,initial,latest,percent});
});

results.sort((a,b)=>b.percent-a.percent);
leaderboard.innerHTML="";
results.forEach((r,i)=>{
const color=r.percent>0?"#00ff88":"#ff4d4d";
leaderboard.innerHTML+=`<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.initial}</td>
<td>${r.latest}</td>
<td style="color:${color};font-weight:bold;">${r.percent}%</td>
</tr>`;
});
}

async function addWeight(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
const d=await res.json();
msg.innerText=d.success?`‚úÖ Submitted at ${new Date(d.timestamp).toLocaleString()}`:`‚ö† ${d.message}`;
weight.value="";
loadData();
}

loadData();
setInterval(loadData,30000);
</script>

</body>
</html>
