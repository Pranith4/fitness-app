<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="video-bg">
  <iframe src="https://www.youtube.com/embed/eAlNvWgTDZQ?autoplay=1&mute=1&loop=1&playlist=eAlNvWgTDZQ&controls=0" allow="autoplay"></iframe>
</div>

<div class="header">
  <h2 id="welcome"></h2>
  <button onclick="refreshData()">üîÑ Refresh</button>
</div>

<div class="tabs">
  <button onclick="showTab('overview')" id="overviewTab" class="activeTab">Overview</button>
  <button onclick="showTab('personal')" id="personalTab">My Journey</button>
</div>

<!-- üåç OVERVIEW TAB -->
<div id="overviewSection">

  <div class="grid">
    <div class="card"><h3>Daily Progress</h3><canvas id="dailyChart"></canvas></div>
    <div class="card"><h3>Monthly Avg</h3><canvas id="monthlyChart"></canvas></div>
  </div>

  <div class="card">
    <h3>üèÜ Leaderboard</h3>
    <table>
      <thead>
        <tr><th>Rank</th><th>Name</th><th>Start</th><th>Current</th><th>% Change</th></tr>
      </thead>
      <tbody id="leaderboard"></tbody>
    </table>
  </div>

</div>

<!-- üë§ PERSONAL TAB -->
<div id="personalSection" class="hidden">

  <div class="card">
    <h3>Add Today's Weight</h3>
    <input id="weight" placeholder="Enter weight">
    <button onclick="addWeight()">Submit</button>
    <p id="msg"></p>
  </div>

  <div class="card">
    <h3>üéØ Goal Planner</h3>
    <div id="goalForm">
      <input id="startWeight" placeholder="Start Weight">
      <input id="targetWeight" placeholder="Target Weight">
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button onclick="saveGoal()">Save Goal</button>
    </div>

    <div id="goalStats" class="hidden">
      <p>Total to Lose: <b id="totalLoss"></b> kg</p>
      <p>Total Days: <b id="totalDays"></b></p>
      <p>Daily Required Loss: <b id="dailyLoss"></b></p>
      <p>Expected Today: <b id="expectedToday"></b></p>
      <p>Status: <b id="goalStatus"></b></p>
      <button onclick="resetGoal()">Reset Goal</button>
    </div>
  </div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

let dailyChartInstance, monthlyChartInstance;
let expectedGoalWeight=null;

function showTab(tab){
  overviewSection.classList.toggle("hidden", tab!=='overview');
  personalSection.classList.toggle("hidden", tab!=='personal');
  overviewTab.classList.toggle("activeTab", tab==='overview');
  personalTab.classList.toggle("activeTab", tab==='personal');
}

async function loadData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const rows=await res.json();
if(rows.length===0) return;

const dates=rows.map(r=>new Date(r[1]));
const weights=rows.map(r=>parseFloat(r[2]));
let labels=dates.map(d=>d.toLocaleDateString());

if(dailyChartInstance) dailyChartInstance.destroy();
dailyChartInstance=new Chart(dailyChart,{type:"line",data:{labels,datasets:[{label:"Weight",data:weights,tension:0.3}]}});

loadLeaderboard();
}

async function loadLeaderboard(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getAllWeights"})});
const data=await res.json();
const rows=data.slice(1);
let users={};

rows.forEach(r=>{
if(!users[r[0]]) users[r[0]]=[];
users[r[0]].push({date:new Date(r[1]),weight:parseFloat(r[2])});
});

let results=[];
Object.keys(users).forEach(name=>{
const rec=users[name].sort((a,b)=>a.date-b.date);
results.push({name,initial:rec[0].weight,latest:rec[rec.length-1].weight,percent:((rec[0].weight-rec[rec.length-1].weight)/rec[0].weight*100).toFixed(2)});
});

results.sort((a,b)=>b.percent-a.percent);
leaderboard.innerHTML="";
results.forEach((r,i)=>leaderboard.innerHTML+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.initial}</td><td>${r.latest}</td><td>${r.percent}%</td></tr>`);
}

async function addWeight(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
const d=await res.json();
msg.innerText=d.success?`Submitted at ${new Date(d.timestamp).toLocaleString()}`:d.message;
weight.value="";
loadData();
}

async function saveGoal(){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"saveGoal",username:user,startWeight:startWeight.value,targetWeight:targetWeight.value,startDate:startDate.value,endDate:endDate.value})});
loadGoal();
}

async function loadGoal(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getGoal",username:user})});
const g=await res.json();
if(!g.startWeight){goalForm.classList.remove("hidden");goalStats.classList.add("hidden");return;}

goalForm.classList.add("hidden");
goalStats.classList.remove("hidden");

const sw=parseFloat(g.startWeight);
const tw=parseFloat(g.targetWeight);
const sd=new Date(g.startDate);
const ed=new Date(g.endDate);
const totalDays=Math.ceil((ed-sd)/(1000*60*60*24));
const dailyLoss=((sw-tw)/totalDays);
const today=new Date();
const daysPassed=Math.ceil((today-sd)/(1000*60*60*24));
expectedGoalWeight=(sw-(dailyLoss*daysPassed));

totalLoss.innerText=(sw-tw).toFixed(1);
totalDays.innerText=totalDays;
dailyLoss.innerText=dailyLoss.toFixed(2);
expectedToday.innerText=expectedGoalWeight.toFixed(1);
goalStatus.innerText="Tracking...";
}

function resetGoal(){goalForm.classList.remove("hidden");goalStats.classList.add("hidden");}

function refreshData(){loadData();}

loadData();
loadGoal();
setInterval(loadData,30000);
</script>
</body>
</html>
