<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine Fitness Dashboard</title>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --primary: #00d2ff;
            --gold: #fbbf24;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ff4d4d;
            --success: #00ff88;
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; padding: 15px; display: flex; justify-content: center; }
        
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; width: 100%; max-width: 1400px; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 15px rgba(0,0,0,0.2); }

        /* --- PRIZE & STATS --- */
        .prize-hero { text-align: center; border: 2px solid var(--primary); background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .prize-hero h1 { font-size: 2.5rem; color: var(--primary); margin: 10px 0; text-shadow: 0 0 10px rgba(0,210,255,0.3); }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-box span { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }
        .stat-box h2 { font-size: 1.2rem; color: var(--primary); }

        /* --- PODIUM --- */
        .podium-container { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 120px; margin-top: 15px; }
        .podium-step { background: rgba(0,0,0,0.3); border-radius: 8px 8px 4px 4px; text-align: center; width: 80px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .first { height: 100%; border-color: var(--gold); }
        .second { height: 75%; }
        .third { height: 55%; }
        .podium-step div { font-weight: bold; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- TABLES --- */
        .table-container { overflow-x: auto; border-radius: 12px; background: rgba(0,0,0,0.2); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .matrix-table th, .matrix-table td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sticky-col { position: sticky; left: 0; background: #1e293b !important; font-weight: bold; color: var(--primary); z-index: 5; }

        /* --- CHAT SYSTEM & STATUS LIGHT --- */
        #chat-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 9998; box-shadow: 0 4px 15px rgba(0,210,255,0.4); }
        
        #chat-window { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 480px; background: var(--card-bg); border: 1px solid var(--primary); border-radius: 20px; display: flex; flex-direction: column; z-index: 9999; box-shadow: 0 15px 35px rgba(0,0,0,0.5); transition: 0.3s ease; }
        .chat-hidden { transform: translateY(20px); opacity: 0; pointer-events: none; }

        .chat-header { background: var(--primary); color: #000; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; border-radius: 19px 19px 0 0; }
        .status-container { display: flex; align-items: center; gap: 5px; font-size: 0.65rem; background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; }
        .status-online { background: #00ff00; box-shadow: 0 0 5px #00ff00; animation: pulse 1.5s infinite; }
        .status-loading { background: #ffaa00; }
        .status-offline { background: #ff4d4d; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #chat-body { padding: 15px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; font-size: 0.85rem; }
        .bot-msg { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px 12px 12px 0; align-self: flex-start; max-width: 85%; }
        .user-msg { background: var(--primary); color: #000; padding: 10px; border-radius: 12px 12px 0 12px; align-self: flex-end; max-width: 85%; }
        
        .chat-input-area { display: flex; padding: 12px; gap: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        input, button { width: 100%; padding: 12px; border-radius: 10px; border: none; outline: none; transition: 0.2s; }
        input { background: rgba(0,0,0,0.3); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; }

        @media (max-width: 850px) {
            .layout { grid-template-columns: 1fr; }
            #chat-window { width: calc(100% - 30px); right: 15px; }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-panel">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
            <div class="podium-container">
                <div class="podium-step second"><div id="rank2">--</div><span>2nd</span></div>
                <div class="podium-step first">üëë<div id="rank1">--</div><span>Champ</span></div>
                <div class="podium-step third"><div id="rank3">--</div><span>3rd</span></div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Your Rank</span><h2 id="userRank">--</h2></div>
            <div class="stat-box"><span>Loss %</span><h2 id="userTotalPct">--</h2></div>
            <div class="stat-box"><span>Days Left</span><h2 id="daysLeft">--</h2></div>
        </div>

        <div class="card">
            <h3>‚öîÔ∏è Weight Matrix</h3>
            <div class="table-container"><table id="competitorTable" class="matrix-table"></table></div>
        </div>

        <div class="card">
            <h3>üî• ‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≤≤‡≥ç ‡≤§‡≥Ç‡≤ï ‡≤¶‡≤Ç‡≤° ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü</h3>
            <div class="table-container"><table id="skipTable" class="matrix-table"></table></div>
        </div>
    </div>

    <div class="side-panel">
        <div class="card">
            <h2 id="welcomeText">Athlete</h2>
            <p id="countdown" style="color:var(--gold); font-size:0.8rem; margin-top:5px;">--:--:--</p>
        </div>

        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <p style="font-size:0.65rem; color:var(--text-muted); margin-bottom:8px;">Only allowed on Mondays.</p>
            <input type="number" step="0.1" id="weightInput" placeholder="Enter Weight (kg)">
            <button onclick="addWeight()" id="submitBtn">Submit Monday Entry</button>
        </div>
        
        <div class="card">
            <h3 style="color:var(--gold)">Prize Contribution üî•</h3>
            <p style="font-size:0.7rem; margin-bottom:10px;">Contribution: ‚Çπ100</p>
            <button onclick="copyUPI()" style="background:var(--gold)">8431257887@ybl</button>
        </div>
    </div>
</div>

<div id="chat-icon" onclick="toggleChat()">ü§ñ</div>
<div id="chat-window" class="chat-hidden">
    <div class="chat-header">
        <div style="display:flex; align-items:center; gap:8px;">
            <span>Coach AI</span>
            <div class="status-container">
                <div id="status-dot" class="status-dot status-online"></div>
                <span id="status-text">ONLINE</span>
            </div>
        </div>
        <span onclick="toggleChat()" style="cursor:pointer">&times;</span>
    </div>
    <div id="chat-body"><div class="bot-msg">Welcome! I am your Fitness Coach. I can help with diet tips, workout advice, or explaining the challenge rules.</div></div>
    <div class="chat-input-area">
        <input type="text" id="userQuery" placeholder="Ask Coach..." style="margin:0">
        <button onclick="coachResponse()" style="width:50px; margin:0">üöÄ</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
    const HF_TOKEN = "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";
    const user = localStorage.getItem("user") || "Guest";
    document.getElementById("welcomeText").innerText = user;

    // --- CHAT LOGIC ---
    function toggleChat() { document.getElementById("chat-window").classList.toggle("chat-hidden"); }

    function updateStatus(state) {
        const dot = document.getElementById("status-dot");
        const text = document.getElementById("status-text");
        dot.className = "status-dot";
        if(state === "online") { dot.classList.add("status-online"); text.innerText = "ONLINE"; }
        else if(state === "loading") { dot.classList.add("status-loading"); text.innerText = "THINKING..."; }
        else { dot.classList.add("status-offline"); text.innerText = "OFFLINE"; }
    }

    async function coachResponse() {
    const input = document.getElementById("userQuery");
    const body = document.getElementById("chat-body");
    const query = input.value.trim();
    if(!query) return;

    body.innerHTML += `<div class="user-msg">${query}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;
    updateStatus("loading");

    const loadId = "load-" + Date.now();
    body.innerHTML += `<div class="bot-msg" id="${loadId}">Thinking...</div>`;

    try {
        // Direct call to HF - Vercel handles HTTPS-to-HTTPS fine
        const res = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2", {
            method: "POST",
            headers: { 
                "Authorization": `Bearer ${HF_TOKEN}`, 
                "Content-Type": "application/json",
                // Removing unnecessary headers that sometimes cause CORS pre-flight failure
            },
            body: JSON.stringify({
                inputs: `[INST] You are the Dark Shine Fitness Coach. Answer briefly: ${query} [/INST]`,
                parameters: { max_new_tokens: 150, wait_for_model: true } // Added wait_for_model
            }),
        });

        const data = await res.json();

        if (!res.ok) {
            // This will tell us if it's 401 (Token), 429 (Rate Limit), or 503 (Loading)
            throw new Error(data.error || `HTTP Error ${res.status}`);
        }

        let reply = data[0].generated_text.split("[/INST]").pop().trim();
        document.getElementById(loadId).innerText = reply;
        updateStatus("online");

    } catch (e) {
        console.error("AI Error:", e.message);
        // If it still fails, the error message will appear in the chat for you to see
        document.getElementById(loadId).innerText = "Error: " + e.message;
        updateStatus("offline");
    }
    body.scrollTop = body.scrollHeight;
}

    // --- DASHBOARD DATA ---
    async function init() {
        try {
            const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"getAllWeights"})});
            const data = await res.json();
            if(data.length > 1) renderTables(data);
        } catch(e) { console.log("Init failed"); }
    }

    function renderTables(data) {
        const rows = data.slice(1);
        let usersMap = {}, datesSet = new Set();
        rows.forEach(r => {
            const d = new Date(r[1]); d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1));
            const label = d.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
            datesSet.add(label);
            if(!usersMap[r[0]]) usersMap[r[0]] = {};
            usersMap[r[0]][label] = parseFloat(r[2]);
        });
        const dates = [...datesSet].sort((a,b) => new Date(a) - new Date(b));
        
        let h1 = `<thead><tr><th class="sticky-col">Athlete</th>`, h2 = h1;
        dates.forEach(d => { h1 += `<th>${d}</th>`; h2 += `<th>${d}</th>`; });
        h1 += `<th>Total %</th></tr></thead><tbody>`; h2 += `</tr></thead><tbody>`;

        let lb = Object.keys(usersMap).map(u => {
            const vals = dates.map(d => usersMap[u][d]).filter(v => v);
            const total = (((vals[0] - vals[vals.length-1])/vals[0])*100).toFixed(2);
            let week = vals.length > 1 ? (((vals[vals.length-2]-vals[vals.length-1])/vals[vals.length-2])*100) : -999;
            return { name: u, total: parseFloat(total), week };
        });

        const sorted = lb.sort((a,b) => b.total - a.total);
        const wkSort = [...lb].sort((a,b) => b.week - a.week);
        
        document.getElementById("rank1").innerText = wkSort[0]?.name || "--";
        document.getElementById("rank2").innerText = wkSort[1]?.name || "--";
        document.getElementById("rank3").innerText = wkSort[2]?.name || "--";
        
        const myIdx = sorted.findIndex(i => i.name === user);
        document.getElementById("userRank").innerText = myIdx >= 0 ? `#${myIdx + 1}` : "--";
        document.getElementById("userTotalPct").innerText = myIdx >= 0 ? `${sorted[myIdx].total}%` : "--";

        sorted.forEach(item => {
            h1 += `<tr><td class="sticky-col">${item.name}</td>`;
            h2 += `<tr><td class="sticky-col">${item.name}</td>`;
            dates.forEach((d, i) => {
                const v = usersMap[item.name][d] || '-';
                h1 += `<td>${v}</td>`;
                let delta = (i > 0 && usersMap[item.name][dates[i-1]] && usersMap[item.name][d]) ? `<div style="font-size:0.6rem; color:var(--success)">${(((usersMap[item.name][dates[i-1]]-v)/usersMap[item.name][dates[i-1]])*100).toFixed(1)}%</div>` : "";
                h2 += `<td>${v}${delta}</td>`;
            });
            h1 += `<td>${item.total}%</td></tr>`; h2 += `</tr>`;
        });
        document.getElementById("competitorTable").innerHTML = h1;
        document.getElementById("skipTable").innerHTML = h2;
    }

    function copyUPI() { navigator.clipboard.writeText("8431257887@ybl").then(() => alert("UPI Copied!")); }
    init();
</script>
</body>
</html>
