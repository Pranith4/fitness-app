<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Shine | Fitness Dashboard</title>
    <style>
        /* Paste the COMPLETE CSS provided in the previous message here */
        :root { --bg: #0f172a; --card-bg: #1e293b; --primary: #00d2ff; --gold: #fbbf24; --text: #f8fafc; --text-muted: #94a3b8; --danger: #ff4d4d; --success: #00ff88; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; display: flex; justify-content: center; }
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; width: 100%; max-width: 1400px; }
        .card { background: var(--card-bg); padding: 24px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .prize-hero { text-align: center; border: 2px solid var(--primary); background: linear-gradient(145deg, #1e293b, #0f172a); }
        .prize-hero h1 { font-size: 3rem; color: var(--primary); margin: 10px 0; }
        .goal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .goal-box { background: rgba(15, 23, 42, 0.5); padding: 15px 10px; border-radius: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .goal-box span { font-size: 0.65rem; color: var(--text-muted); display: block; text-transform: uppercase; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; margin-top: 5px; }
        .on-track { background: rgba(0, 255, 136, 0.1); color: var(--success); border: 1px solid var(--success); }
        .off-track { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 18px 10px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-box h2 { font-size: 1.3rem; color: var(--primary); margin-top: 5px; }
        .table-container { overflow-x: auto; border-radius: 14px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 550px; }
        .matrix-table th { background: rgba(255,255,255,0.03); color: var(--gold); padding: 15px; text-transform: uppercase; }
        .matrix-table td { padding: 14px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .sticky-col { position: sticky; left: 0; background: var(--card-bg) !important; font-weight: bold; color: var(--primary); z-index: 10; }
        #chat-trigger { position: fixed; bottom: 25px; right: 25px; background: var(--primary); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 1001; }
        #chat-window { position: fixed; bottom: 100px; right: 25px; width: 360px; height: 500px; background: var(--card-bg); border: 1px solid var(--primary); border-radius: 24px; display: flex; flex-direction: column; z-index: 1000; overflow: hidden; }
        .chat-hidden { display: none; }
        .chat-header { background: var(--primary); color: #0f172a; padding: 16px 20px; font-weight: 800; display: flex; justify-content: space-between; }
        #chat-body { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bot-msg { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 15px 15px 15px 0; align-self: flex-start; font-size: 0.85rem; }
        .user-msg { background: var(--primary); color: #0f172a; padding: 12px; border-radius: 15px 15px 0 15px; align-self: flex-end; font-size: 0.85rem; }
        .chat-input { display: flex; padding: 15px; gap: 10px; background: rgba(0,0,0,0.2); }
        input { background: #0f172a; color: #fff; border: 1px solid #334155; padding: 12px; border-radius: 10px; flex-grow: 1; outline: none; }
        button { background: var(--primary); color: #0f172a; border: none; padding: 12px 18px; border-radius: 10px; font-weight: 800; cursor: pointer; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-content">
        <div class="card prize-hero">
            <h3>üèÜ CHALLENGE PRIZE POOL</h3>
            <h1>‚Çπ6,000</h1>
        </div>

        <div class="card">
            <h3 style="color:var(--gold)">üéØ Live Progress</h3>
            <div class="goal-grid">
                <div class="goal-box"><span>Days Left</span><h4 id="stat-days">--</h4></div>
                <div class="goal-box"><span>Next Target</span><h4 id="stat-next-week">--</h4></div>
                <div class="goal-box"><span>Status</span><div id="stat-status" class="status-badge">Syncing...</div></div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><span>Weight Loss %</span><h2 id="stat-loss">--</h2></div>
            <div class="stat-box"><span>Current</span><h2 id="stat-current">--</h2></div>
            <div class="stat-box"><span>Target</span><h2 id="stat-target">--</h2></div>
        </div>

        <div class="card">
            <h3>Matrix Standings</h3>
            <div id="table-container" class="table-container">Fetching leaderboard...</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h2 id="userName">Athlete</h2>
            <p style="color:var(--text-muted); font-size: 0.8rem;">Welcome to Dark Shine.</p>
        </div>
        <div class="card">
            <h3>‚öñÔ∏è Log Weight</h3>
            <input type="number" step="0.1" id="weightInput" placeholder="Enter Weight (kg)">
            <button onclick="submitWeight()" style="width:100%; margin-top:10px">Update Sheets</button>
        </div>
    </div>
</div>

<div id="chat-trigger" onclick="toggleChat()">ü§ñ</div>
<div id="chat-window" class="chat-hidden">
    <div class="chat-header"><span>Coach AI</span><span onclick="toggleChat()" style="cursor:pointer">&times;</span></div>
    <div id="chat-body"><div class="bot-msg">How can I help you reach your goals today?</div></div>
    <div class="chat-input"><input type="text" id="userQuery" placeholder="Ask Coach..."><button onclick="coachResponse()">üöÄ</button></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
    const HF_TOKEN = "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";
    
    // FETCH USER NAME FROM PREVIOUS WORKING KEY
    const CURRENT_USER = localStorage.getItem("user") || localStorage.getItem("username") || "Guest";
    document.getElementById("userName").innerText = CURRENT_USER;

    async function init() {
        if (CURRENT_USER === "Guest") return;

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            // Your API structure: looks for USERS and ENTRIES sheets
            const userGoals = data.users.find(u => u.name.trim().toLowerCase() === CURRENT_USER.toLowerCase());
            const userEntries = data.entries.filter(e => e.name.trim().toLowerCase() === CURRENT_USER.toLowerCase());

            if (userGoals) {
                const latestWeight = userEntries.length > 0 ? userEntries[userEntries.length-1].weight : userGoals.startWeight;
                
                // Update Stat Boxes
                document.getElementById("stat-current").innerText = latestWeight + " kg";
                document.getElementById("stat-target").innerText = userGoals.targetWeight + " kg";
                
                const lossPct = ((userGoals.startWeight - latestWeight) / userGoals.startWeight * 100).toFixed(2);
                document.getElementById("stat-loss").innerText = lossPct + "%";

                // Update Goal Tracker Card
                calculateGoalStats(latestWeight, userGoals.targetWeight, userGoals.endDate, userGoals.startWeight, userGoals.startDate);
                
                // Render Leaderboard
                renderTable(data.entries);
            }
        } catch (e) {
            console.error("Dashboard Error:", e);
        }
    }

    function calculateGoalStats(current, target, endStr, startWeight, startStr) {
        const today = new Date();
        const endDate = new Date(endStr);
        const startDate = new Date(startStr);

        const diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        document.getElementById("stat-days").innerText = diffDays > 0 ? diffDays : "0";

        const weeksLeft = diffDays / 7;
        const nextTarget = (current - ((current - target) / weeksLeft)).toFixed(1);
        document.getElementById("stat-next-week").innerText = weeksLeft > 0 ? nextTarget + " kg" : "Goal Hit";

        const totalTime = endDate - startDate;
        const elapsed = today - startDate;
        const ideal = startWeight - ((startWeight - target) * (elapsed / totalTime));

        const status = document.getElementById("stat-status");
        if (current <= ideal + 0.5) {
            status.innerText = "ON TRACK";
            status.className = "status-badge on-track";
        } else {
            status.innerText = "BEHIND PACE";
            status.className = "status-badge off-track";
        }
    }

    function renderTable(entries) {
        let html = `<table class="matrix-table"><thead><tr><th class="sticky-col">Name</th><th>Start</th><th>Current</th><th>Loss %</th></tr></thead><tbody>`;
        // Simplified rendering for example - replace with your specific matrix logic if needed
        entries.forEach(e => {
            html += `<tr><td class="sticky-col">${e.name}</td><td>${e.start || '--'}</td><td>${e.weight}</td><td>${e.pct || '0'}%</td></tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById("table-container").innerHTML = html;
    }

    async function coachResponse() {
        const query = document.getElementById("userQuery").value;
        if(!query) return;
        document.getElementById("chat-body").innerHTML += `<div class="user-msg">${query}</div>`;
        document.getElementById("userQuery").value = "";

        try {
            const res = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2", {
                method: "POST",
                headers: { "Authorization": `Bearer ${HF_TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({ inputs: `[INST] You are a fitness coach. Briefly answer: ${query} [/INST]` })
            });
            const data = await res.json();
            const reply = data[0].generated_text.split("[/INST]").pop().trim();
            document.getElementById("chat-body").innerHTML += `<div class="bot-msg">${reply}</div>`;
        } catch (e) { document.getElementById("chat-body").innerHTML += `<div class="bot-msg">Connection error.</div>`; }
    }

    function toggleChat() { document.getElementById("chat-window").classList.toggle("chat-hidden"); }
    
    init();
</script>
</body>
</html>
