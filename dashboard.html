<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
  <h2 id="welcome"></h2>
  <button onclick="toggleForm()">+ Add Weight</button>
</div>

<div id="formCard" class="card hidden">
  <input id="weight" placeholder="Enter weight">
  <button onclick="addWeight()">Submit</button>
  <p id="msg"></p>
</div>

<div class="stats">
  <div class="card"><h3>ğŸ”¥ Streak</h3><p id="streak">0 days</p></div>
  <div class="card"><h3>ğŸ¯ Goal Progress</h3><p id="goalProgress">--</p></div>
  <div class="card"><h3>ğŸ“‰ Trend</h3><p id="trend">--</p></div>
</div>

<div id="noData" class="centerMsg hidden">No data yet. Add weight ğŸ“ˆ</div>

<div class="grid">
  <div class="card"><h3>Daily Progress</h3><canvas id="dailyChart"></canvas></div>
  <div class="card"><h3>Monthly Avg</h3><canvas id="monthlyChart"></canvas></div>
</div>

<div class="card">
  <h3>ğŸ† Leaderboard</h3>
  <ul id="leaderboard"></ul>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzwWrCRjHYeJA0-5SHxAamG-H96m5ItJzOXtNhgu0sy43xIlkCPLTeayK6bKT1-S9-Raw/exec";
const user=localStorage.getItem("user");
if(!user) window.location="index.html";
welcome.innerText="Welcome, "+user;

function toggleForm(){ formCard.classList.toggle("hidden"); }

async function loadData(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getWeights",username:user})});
const data=await res.json();

if(data.length<=1){noData.classList.remove("hidden");return;}

const rows=data.slice(1);
const weights=rows.map(r=>parseFloat(r[2]));
const dates=rows.map(r=>new Date(r[1]));

let streakCount=1;
for(let i=dates.length-1;i>0;i--){
if((dates[i]-dates[i-1])/(1000*60*60*24)<=1.5) streakCount++;
else break;
}
streak.innerText=streakCount+" days";

let diff=weights[weights.length-1]-weights[0];
trend.innerText=diff<0?"â¬‡ Losing":"â¬† Gaining";

goalProgress.innerText="Set goal in sheet";

const labels=dates.map(d=>d.toLocaleDateString());
new Chart(dailyChart,{type:"line",data:{labels:labels,datasets:[{label:"Weight",data:weights}]}});

let monthData={};
rows.forEach(r=>{
let m=new Date(r[1]).toLocaleString('default',{month:'short'});
if(!monthData[m]) monthData[m]=[];
monthData[m].push(parseFloat(r[2]));
});
new Chart(monthlyChart,{type:"bar",data:{labels:Object.keys(monthData),datasets:[{label:"Avg",data:Object.values(monthData).map(a=>a.reduce((x,y)=>x+y)/a.length)}]}});

loadLeaderboard();
}

async function loadLeaderboard(){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getAllWeights"})
  });

  const data = await res.json();
  const rows = data.slice(1);

  let users = {};

  rows.forEach(r=>{
    const name = r[0];
    const weight = parseFloat(r[2]);
    const date = new Date(r[1]);

    if(!users[name]) users[name] = [];
    users[name].push({date, weight});
  });

  let results = [];

  Object.keys(users).forEach(name=>{
    const records = users[name].sort((a,b)=>a.date-b.date);

    const initial = records[0].weight;
    const latest = records[records.length-1].weight;

    const percent = ((initial - latest) / initial * 100).toFixed(2);

    results.push({name, initial, latest, percent});
  });

  results.sort((a,b)=>b.percent - a.percent);

  leaderboard.innerHTML = `
    <li><b>Name | Start | Now | % Change</b></li>
  `;

  results.forEach(r=>{
    const color = r.percent > 0 ? "lime" : "red";
    leaderboard.innerHTML += `
      <li style="color:${color}">
        ${r.name} | ${r.initial}kg â†’ ${r.latest}kg | ${r.percent}%
      </li>
    `;
  });
}


async function addWeight(){
const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addWeight",username:user,weight:weight.value})});
const d=await res.json();
msg.innerText=d.success?`âœ… Submitted at ${new Date(d.timestamp).toLocaleString()}`:`âš  ${d.message}`;
weight.value="";
loadData();
}

loadData();
</script>
</body>
</html>
